# Claude Code 에이전트 상호작용 아키텍처

이 문서는 FHLY 프로젝트 개발 시 Claude Code의 에이전트(Skills + 서브에이전트)가 어떻게 상호작용하는지 설명합니다.

## 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                        사용자 (개발자)                           │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Claude Code (Main)                         │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Skills Layer                           │  │
│  │  /commit  /review  /test  /mcp-scaffold  /explain  ...   │  │
│  └───────────────────────────┬───────────────────────────────┘  │
│                              │                                   │
│  ┌───────────────────────────▼───────────────────────────────┐  │
│  │                 Task Tool (Subagents)                     │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────────┐  │  │
│  │  │ Explore │ │  Plan   │ │  Bash   │ │ general-purpose │  │  │
│  │  │  Agent  │ │  Agent  │ │  Agent  │ │     Agent       │  │  │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## Skills과 서브에이전트의 관계

### Skills = 진입점

Skills는 사용자가 `/command` 형태로 호출하는 진입점입니다.

```
사용자: /review src/main.py
    │
    ▼
┌─────────────────────────────────────┐
│ /review Skill (SKILL.md)            │
│ - 리뷰 지시사항 정의                 │
│ - 필요시 서브에이전트 활용 지시       │
└─────────────────────────────────────┘
```

### 서브에이전트 = 실행자

복잡한 작업은 서브에이전트에게 위임됩니다.

```
/review Skill
    │
    ├──▶ Explore Agent: 파일 탐색 및 구조 파악
    │
    └──▶ general-purpose Agent: 실제 리뷰 수행
```

---

## 워크플로우별 상호작용

### 워크플로우 1: 코드 커밋

```
┌──────────┐    ┌────────────────┐    ┌────────────┐
│ /commit  │───▶│ Bash Agent     │───▶│ Git 명령   │
│ Skill    │    │ (git diff/add) │    │ 실행       │
└──────────┘    └────────────────┘    └────────────┘
     │
     ▼
┌────────────────────────────────────────────────┐
│ 변경사항 분석 → Semantic Commit 메시지 생성     │
└────────────────────────────────────────────────┘
```

**흐름:**
1. 사용자: `/commit`
2. Skill이 git diff 분석 지시
3. Bash Agent가 git status/diff 실행
4. Claude가 변경사항 분석 후 커밋 메시지 생성
5. Bash Agent가 git commit 실행

---

### 워크플로우 2: 코드 리뷰

```
┌──────────┐    ┌────────────────┐    ┌────────────────┐
│ /review  │───▶│ Explore Agent  │───▶│ 파일 구조      │
│ Skill    │    │ (파일 탐색)     │    │ 파악          │
└──────────┘    └────────────────┘    └────────────────┘
     │
     ▼
┌────────────────────────────────────────────────┐
│ 보안/성능/가독성 관점 리뷰 수행                  │
└────────────────────────────────────────────────┘
     │
     ▼
┌────────────────────────────────────────────────┐
│ 개선 제안 및 수정 코드 제시                      │
└────────────────────────────────────────────────┘
```

---

### 워크플로우 3: MCP 서버 개발

```
┌───────────────┐
│ /mcp-scaffold │
│ Skill         │
└───────┬───────┘
        │
        ▼
┌───────────────────────────────────────────────────┐
│ 1. Explore Agent: 기존 MCP 서버 구조 참조          │
└───────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────┐
│ 2. general-purpose Agent: 프로젝트 구조 생성       │
│    - pyproject.toml                               │
│    - server.py (FastMCP 기반)                     │
│    - tools/ 디렉토리                              │
└───────────────────────────────────────────────────┘
        │
        ▼
┌───────────────┐    ┌───────────────────────────────┐
│ /mcp-test     │───▶│ Bash Agent: 서버 연결 테스트   │
│ Skill         │    │ - 도구 목록 확인               │
│               │    │ - 샘플 호출 테스트             │
└───────────────┘    └───────────────────────────────┘
```

---

### 워크플로우 4: TDD 개발

```
┌──────────┐
│ /tdd     │
│ Skill    │
└────┬─────┘
     │
     ▼
┌────────────────────────────────────────────────┐
│ Phase 1: RED - 실패하는 테스트 작성             │
│ → general-purpose Agent                        │
└────────────────────────────────────────────────┘
     │
     ▼
┌────────────────────────────────────────────────┐
│ Phase 2: GREEN - 테스트 통과하는 최소 코드      │
│ → general-purpose Agent                        │
└────────────────────────────────────────────────┘
     │
     ▼
┌────────────────────────────────────────────────┐
│ Phase 3: REFACTOR - 코드 개선                  │
│ → general-purpose Agent                        │
└────────────────────────────────────────────────┘
     │
     ▼
┌────────────────────────────────────────────────┐
│ 검증: Bash Agent (pytest 실행)                 │
└────────────────────────────────────────────────┘
```

---

## 에이전트 역할 매핑

### Skill → 서브에이전트 매핑

| Skill | 주요 서브에이전트 | 역할 |
|-------|-----------------|------|
| `/commit` | Bash | git 명령 실행 |
| `/review` | Explore, general-purpose | 탐색 + 분석 |
| `/test` | general-purpose, Bash | 생성 + 실행 |
| `/explain` | Explore | 코드 탐색 및 설명 |
| `/mcp-scaffold` | general-purpose | 프로젝트 생성 |
| `/mcp-test` | Bash | 서버 테스트 |
| `/overview` | Explore | 구조 분석 |
| `/brainstorm` | Plan | 아이디어 도출 |

---

## 병렬 실행 패턴

독립적인 작업은 병렬로 실행하여 효율성을 높입니다.

```
┌─────────────────────────────────────────────────────┐
│              사용자 요청: "전체 점검"                │
└─────────────────────────┬───────────────────────────┘
                          │
          ┌───────────────┼───────────────┐
          │               │               │
          ▼               ▼               ▼
    ┌──────────┐    ┌──────────┐    ┌──────────┐
    │ /review  │    │ /test    │    │ /lint    │
    │ (병렬)   │    │ (병렬)   │    │ (병렬)   │
    └────┬─────┘    └────┬─────┘    └────┬─────┘
         │               │               │
         └───────────────┼───────────────┘
                         │
                         ▼
              ┌────────────────────┐
              │ 결과 종합 및 보고   │
              └────────────────────┘
```

---

## 컨텍스트 공유

### fork 컨텍스트

`context: fork` 설정 시 서브에이전트가 독립된 컨텍스트에서 실행됩니다.

```yaml
---
name: deep-research
context: fork
agent: Explore
---
```

```
┌─────────────────────────────────────────┐
│ Main Context                            │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │ Fork Context (Explore Agent)     │  │
│  │ - 독립된 대화 기록                 │  │
│  │ - 결과만 Main에 반환              │  │
│  └───────────────────────────────────┘  │
│                                         │
└─────────────────────────────────────────┘
```

### 동적 컨텍스트 주입

`!`command`` 문법으로 명령 결과를 프롬프트에 주입합니다.

```yaml
---
name: pr-review
---
## PR 정보
- Diff: !`git diff main...HEAD`
- 변경 파일: !`git diff --name-only main...HEAD`

위 정보를 바탕으로 리뷰하세요.
```

---

## 에러 핸들링

### 서브에이전트 실패 시

```
┌──────────────┐
│ Skill 호출   │
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────┐
│ 서브에이전트 실행                     │
│                                      │
│  실패 시:                            │
│  1. 에러 메시지 분석                  │
│  2. 대안 접근법 시도                  │
│  3. 사용자에게 상황 보고              │
└──────────────────────────────────────┘
```

---

## 참고 자료

- [Claude Code 에이전트 가이드](agents-guide.md)
- [Skills 사용 가이드](skills-guide.md)
- [FHLY 아키텍처](architecture-scenarios.md)
