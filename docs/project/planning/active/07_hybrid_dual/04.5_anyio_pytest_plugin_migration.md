# Phase 4.5: AnyIO Pytest Plugin Migration (Hotfix)

## Context

Phase 4에서 구현한 McpClientAdapter의 teardown 시 anyio 에러가 발생합니다:

```
RuntimeError: Attempted to exit cancel scope in a different task than it was entered in
```

**근본 원인:** pytest-asyncio가 fixture의 setup과 teardown을 **서로 다른 async task**에서 실행하지만, MCP SDK 내부의 anyio.CancelScope는 **동일 task**를 요구합니다. pytest-asyncio 1.3.0에서도 여전히 미해결 ([pytest-asyncio #1191](https://github.com/pytest-dev/pytest-asyncio/issues/1191)).

**해결책:** AnyIO pytest plugin은 fixture를 **단일 task**에서 실행하므로 이 문제를 근본적으로 해결합니다. `anyio_mode = "auto"` 설정을 지원하여 기존 `asyncio_mode = "auto"`와 동일한 자동 감지를 제공합니다.

**현재 상태:**
- anyio 4.12.0 **이미 설치됨** (transitive dependency)
- pytest-asyncio 1.3.0 설치됨
- 양 플러그인의 auto mode는 **충돌** → 동시 사용 불가

---

## Strategy: Config Switch + Marker Cleanup

| 변경 항목 | 현재 | 변경 후 | 파일 수 |
|-----------|------|---------|---------|
| pytest config | `asyncio_mode = "auto"` | `anyio_mode = "auto"` | 1 |
| `@pytest_asyncio.fixture` | 4개 | `@pytest.fixture` | 2 |
| `import pytest_asyncio` | 2개 | 삭제 | 2 |
| `@pytest.mark.asyncio` | ~195개 (test files) | 삭제 | 39 |

**핵심:** `@pytest.mark.asyncio` 제거가 필수입니다. 남겨두면 pytest-asyncio strict mode가 해당 테스트를 claim → 동일한 teardown 문제 지속.

---

## Potential Issues & Mitigations

### Issue 1: `@pytest.mark.asyncio` 미제거 시 충돌
- **증상:** pytest-asyncio strict mode가 마커 있는 테스트를 claim → 구 방식 실행
- **대응:** 39개 test 파일에서 `@pytest.mark.asyncio` 완전 제거
- **검증:** `grep -r "@pytest.mark.asyncio" tests/` → 0건

### Issue 2: asyncio-specific API (create_task, sleep, gather)
- **위치:** test_sse_broker.py, test_gateway_service.py 등
- **영향:** **없음** - anyio는 asyncio를 기본 backend로 사용, 모든 asyncio API 정상 동작
- **검증:** 해당 테스트 실행으로 확인

### Issue 3: TestClient (동기) + async fixture 조합
- **위치:** integration/adapters/conftest.py의 `authenticated_client`
- **영향:** **없음** - anyio plugin은 sync/async fixture 모두 지원
- **검증:** integration 테스트 전수 실행

### Issue 4: Session-scoped subprocess fixture
- **위치:** tests/conftest.py의 `mcp_synapse_server`, `a2a_echo_agent`
- **영향:** **없음** - 동기 fixture, anyio plugin과 무관
- **검증:** `pytest -m local_mcp` 실행

### Issue 5: docs 내 `@pytest.mark.asyncio` 예시 코드
- **위치:** tests/docs/, docs/developers/ 등 (~16개 in 6 doc files)
- **영향:** 실행 코드 아님, 기능에 영향 없음
- **대응:** Phase 4.5에서는 변경하지 않음 (문서 업데이트는 별도)

---

## Implementation Steps

### Step 4.5.1: GREEN Baseline 확인
```bash
pytest -q --tb=line -x    # 기존 테스트 전체 PASS 확인 (teardown error 제외)
```

### Step 4.5.2: pyproject.toml 수정

**File:** [pyproject.toml](pyproject.toml) (lines 77-97)

변경 사항:
```toml
[tool.pytest.ini_options]
# 삭제: asyncio_mode = "auto"
# 삭제: asyncio_default_fixture_loop_scope = "function"
# 추가:
anyio_mode = "auto"
```

**dev 의존성:** `pytest-asyncio>=0.23.0`는 **유지** (strict mode로 자동 전환, 제거 시 기존 import 정리 범위 확대)

### Step 4.5.3: `@pytest_asyncio.fixture` → `@pytest.fixture` (2 files)

**File 1:** [tests/chaos/conftest.py](tests/chaos/conftest.py)
- Line 20: `import pytest_asyncio` → 삭제
- Line 23: `@pytest_asyncio.fixture` → `@pytest.fixture`
- Line 97: `@pytest_asyncio.fixture` → `@pytest.fixture`
- Line 124: `@pytest_asyncio.fixture` → `@pytest.fixture`

**File 2:** [tests/integration/adapters/conftest.py](tests/integration/adapters/conftest.py)
- Line 24: `import pytest_asyncio` → 삭제
- Line 99: `@pytest_asyncio.fixture` → `@pytest.fixture`

### Step 4.5.4: `@pytest.mark.asyncio` 제거 (39 test files, ~195개)

**주의:** 들여쓰기가 2종류 존재:
- **0-indent** (top-level 함수): 31개 (11 files)
- **4-space indent** (class 내부): ~164개 (28 files)

**방법:** Python 스크립트로 정규식 일괄 제거 (들여쓰기 무관하게 처리)

```python
# 모든 indent level의 @pytest.mark.asyncio 라인 제거
import re, pathlib
for f in pathlib.Path("tests").rglob("*.py"):
    content = f.read_text(encoding="utf-8")
    new = re.sub(r" *@pytest\.mark\.asyncio\n", "", content)
    if new != content:
        f.write_text(new, encoding="utf-8")
```

**제거 대상 파일 (39개):**
- tests/unit/ (22 files): fakes/2, domain/1, domain/services/6, adapters/13
- tests/integration/adapters/ (16 files)
- tests/fixtures/ (1 file)

### Step 4.5.5: GREEN 검증

```bash
# 1. 전체 테스트 실행
pytest -q --tb=line -x

# 2. MCP 통합 테스트 (teardown error 해소 확인)
pytest -m local_mcp -v --tb=long

# 3. Coverage 확인
pytest --cov=src --cov-fail-under=80 -q
```

**성공 기준:**
- 전체 테스트 PASS (기존과 동일 수)
- MCP 테스트: PASS **+ teardown ERROR 0건**
- Coverage: 80% 이상 유지

### Step 4.5.6: 문서 업데이트

**목표:** Phase 4.5 pytest-asyncio → anyio plugin 마이그레이션 문서화

#### 문서화 항목:

| 작업 | 대상 파일 | 유형 | 내용 |
|------|----------|------|------|
| **Create** | `docs/project/decisions/technical/ADR-T08-anyio-pytest-plugin-migration.md` | ADR | pytest-asyncio → anyio plugin 마이그레이션 결정 기록 |
| **Modify** | `docs/project/decisions/technical/README.md` | Directory Structure | ADR-T08 추가 |
| **Modify** | `tests/docs/RESOURCES.md` (line 20) | Known Issue 해결 | "~~Known Issue~~: **Resolved (Phase 4.5)** - anyio plugin 도입으로 teardown 에러 해소" |
| **Modify** | `tests/docs/CONFIGURATION.md` (lines 57-69) | Configuration | Section 제목: "⚡ Async Test Configuration (AnyIO Plugin)", 내용: `anyio_mode = "auto"` 설명, pytest-asyncio 참조 완전 제거 |
| **Modify** | `tests/docs/TROUBLESHOOTING.md` (lines 26-28) | Troubleshooting | "pytest-asyncio 에러" → "anyio plugin 에러", 내용: anyio 관련 트러블슈팅으로 교체 |
| **Modify** | `tests/docs/WritingGuide.md` (lines 38, 42, 269+) | Guide | `asyncio_mode` → `anyio_mode` 전체 참조 수정, Recipe 2의 설명 업데이트 |
| **Modify** | `tests/README.md` (line 11) | Quick Reference | "asyncio 모드 \| auto" → "anyio 모드 \| auto" |
| **Modify** | `src/adapters/outbound/mcp/README.md` (lines 169-183) | Known Issues | "Known Issues" 섹션 전체 제거 OR "~~Known Issue~~: Resolved (Phase 4.5)" 표시 |

#### ADR-T08 작성 내용:

**제목:** ADR-T08: AnyIO Pytest Plugin Migration

**상태:** Accepted

**컨텍스트:**
- pytest-asyncio는 fixture setup/teardown을 서로 다른 async task에서 실행
- MCP SDK 내부 anyio.CancelScope는 동일 task 진입/탈출을 요구
- Phase 4 McpClientAdapter에서 "Attempted to exit cancel scope in a different task" 에러 발생

**결정:**
- pytest-asyncio 제거, anyio pytest plugin으로 전환
- `anyio_mode = "auto"` 사용 (기존 `asyncio_mode = "auto"`와 동일한 자동 감지)
- 전체 `@pytest.mark.asyncio` 마커 제거 (39개 파일, ~195개)

**근거:**
- anyio plugin은 fixture를 단일 task 내에서 실행 → teardown 에러 해소
- anyio는 asyncio를 기본 backend로 사용 → 기존 asyncio API 호환성 유지
- auto mode 지원으로 마이그레이션 비용 최소화

**대안:**
- Alternative 1: AsyncExitStack 대신 manual cleanup → 복잡도 증가
- Alternative 2: MCP SDK 업데이트 대기 → 타임라인 불확실

**결과:**
- Phase 4.5에서 41개 파일 수정 (pyproject.toml + 2 conftest + 39 test files)
- teardown 에러 해소, 테스트 안정성 향상
- 문서: tests/docs/ 전체 업데이트 (CONFIGURATION, TROUBLESHOOTING, WritingGuide, RESOURCES)

**참고:**
- [pytest-asyncio #1191](https://github.com/pytest-dev/pytest-asyncio/issues/1191)
- [AnyIO Documentation](https://anyio.readthedocs.io/)
- [Phase 04.5 Document](../../planning/active/07_hybrid_dual/04.5_anyio_pytest_plugin_migration.md)

---

#### 문서 수정 상세 지침:

**1. tests/docs/RESOURCES.md (line 20):**

변경 전:
```markdown
**Known Issue**: AsyncExitStack teardown 시 anyio 에러 (테스트는 PASSED, teardown만 실패)
```

변경 후:
```markdown
**~~Known Issue~~: Resolved (Phase 4.5)** - anyio pytest plugin 도입으로 AsyncExitStack teardown 에러 해소
```

**2. tests/docs/CONFIGURATION.md (lines 57-69):**

변경 전:
```markdown
## **⚡ Async Test Configuration**

### **asyncio_mode = "auto"**

**pyproject.toml:**

[tool.pytest.ini_options]
asyncio_mode = "auto"

**효과:**
* async def test_*() 형식의 테스트를 자동으로 비동기 테스트로 인식
* @pytest.mark.asyncio 데코레이터가 불필요해짐 (기존 코드 호환)
```

변경 후:
```markdown
## **⚡ Async Test Configuration (AnyIO Plugin)**

### **anyio_mode = "auto"**

**pyproject.toml:**

[tool.pytest.ini_options]
anyio_mode = "auto"

**효과:**
* async def test_*() 형식의 테스트를 자동으로 비동기 테스트로 인식
* @pytest.mark.asyncio 데코레이터 불필요 (auto mode)
* anyio는 asyncio를 기본 backend로 사용하여 기존 asyncio API와 호환

**마이그레이션 배경:**
* pytest-asyncio는 fixture setup/teardown을 서로 다른 task에서 실행
* MCP SDK의 anyio.CancelScope는 동일 task 진입/탈출 요구
* anyio plugin은 fixture를 단일 task에서 실행하여 이 문제 해소

**관련 문서:** [ADR-T08: AnyIO Pytest Plugin Migration](../../project/decisions/technical/ADR-T08-anyio-pytest-plugin-migration.md)
```

**3. tests/docs/TROUBLESHOOTING.md (lines 26-28):**

변경 전:
```markdown
### **pytest-asyncio 에러**

* pyproject.toml에 asyncio_mode = "auto"가 설정되어 있는지 확인하십시오.
```

변경 후:
```markdown
### **anyio plugin 에러**

* pyproject.toml에 `anyio_mode = "auto"`가 설정되어 있는지 확인하십시오.
* `@pytest.mark.asyncio` 마커가 남아있지 않은지 확인 (anyio plugin과 충돌)
* asyncio API (create_task, gather 등)는 anyio가 기본 backend로 사용하여 정상 동작
```

**4. tests/docs/WritingGuide.md:**

- Line 38: `asyncio_mode = "auto"` → `anyio_mode = "auto"`
- Line 42: 주석 업데이트 (`# anyio_mode="auto"이므로 @pytest.mark.asyncio 불필요`)
- Line 269: `asyncio_mode` → `anyio_mode`
- **전체 파일 검색:** `@pytest.mark.asyncio` 참조가 있다면 "불필요함" 명시

**5. src/adapters/outbound/mcp/README.md (lines 169-183):**

변경 전:
```markdown
## Known Issues

### AsyncExitStack Teardown Error

**현상:**
- pytest teardown 시 `RuntimeError: Attempted to exit cancel scope in a different task` 발생
...

**해결 방안:**
- Phase 5에서 AsyncExitStack 대신 다른 방법 검토
- 또는 MCP SDK 업데이트 대기
```

변경 후:
```markdown
## ~~Known Issues~~ (Resolved)

### ~~AsyncExitStack Teardown Error~~ (Resolved in Phase 4.5)

**해결:** anyio pytest plugin 도입으로 fixture가 단일 task에서 실행되어 이 문제 해소

**상세:** [ADR-T08: AnyIO Pytest Plugin Migration](../../../../docs/project/decisions/technical/ADR-T08-anyio-pytest-plugin-migration.md)
```

#### 검증:

```bash
# 1. 문서 링크 및 구조 검증
python scripts/validate_docs.py

# 2. 문서 내 stale 참조 확인
grep -r "@pytest.mark.asyncio" docs/
grep -r "asyncio_mode" docs/ tests/docs/
grep -r "pytest-asyncio" docs/ tests/docs/

# 3. 기대 결과
# - docs/ 내 @pytest.mark.asyncio 참조: 0건 (또는 "불필요" 명시)
# - asyncio_mode 참조: 0건
# - pytest-asyncio 참조: ADR-T08에서만 언급
```

#### 주의사항:

- **docs/ 내 예시 코드는 변경하지 않음** (Phase 문서에서 명시한 대로)
- ADR-T08은 간결하게 작성 (1-2 페이지, 결정 중심)
- MAP.md는 수정 불필요 (technical/ 폴더는 이미 존재)
- docs/llms.txt는 수정 불필요 (anyio는 구현 세부사항)

### Step 4.5.7: Commit

```bash
git add -f <changed files>
git commit -m "refactor: migrate pytest-asyncio to anyio plugin (Phase 4.5)"
```

---

## Verification

| 검증 항목 | 명령어 | 기대 결과 |
|-----------|--------|-----------|
| Unit Tests | `pytest tests/unit/ -q --tb=line` | 전체 PASS |
| Integration Tests | `pytest tests/integration/ -q --tb=line` | 전체 PASS |
| MCP Teardown | `pytest -m local_mcp -v --tb=long` | PASS + ERROR 0건 |
| Coverage | `pytest --cov=src --cov-fail-under=80 -q` | >= 80% |
| Marker 잔여 확인 | `grep -r "@pytest.mark.asyncio" tests/` | test 파일 0건 |
| Import 잔여 확인 | `grep -r "import pytest_asyncio" tests/` | 0건 |

---

## Rollback Plan

문제 발생 시 즉시 복구:
```bash
git checkout -- pyproject.toml tests/
```
모든 변경이 test 인프라에 국한되므로 프로덕션 코드(src/) 영향 없음.
