# Plan: DEV_MODE Implementation - GREEN Baseline Recovery

## Context

**문제:** 501ccef 커밋("chore: improve documentation structure and test coverage")에서 **테스트만 대량 추가하고 대응하는 구현을 누락**하여 GREEN baseline이 깨짐.

**영향:**
- 7개 테스트 실패 (test_dev_mode_settings.py: 4개, test_dev_mode_test_utils.py: 3개)
- Phase 4.5 (anyio migration) 진행 불가

**목표:** TDD 사이클 완성 (Red → Green → Refactor) + GREEN baseline 복구

## Architecture Compliance

### Hexagonal Architecture

**현재 문제:**
- `os.getenv("DEV_MODE")` 직접 사용 (app.py, security.py)
- Config 레이어 우회 → Dependency Inversion 원칙 위반

**해결 방안:**
1. Settings (Config 레이어)가 환경변수 로드
2. Adapters는 Settings를 DI Container로 주입받음
3. 단일 진실 원천: `Settings.dev_mode`

**예외:**
- `security.py`: Middleware는 DI Container 접근 불가 → `os.getenv` 유지 (architecture trade-off)

### TDD Cycle

| Phase | Status | 내용 |
|-------|--------|------|
| **RED** | ✅ Complete | 테스트 작성됨 (501ccef) |
| **GREEN** | ⏳ This Plan | 구현 추가 (Step 1-2) |
| **REFACTOR** | ⏳ This Plan | os.getenv → Settings.dev_mode (Step 3) |

## Implementation Plan

### Step 1: Settings.dev_mode 필드 추가 (TDD GREEN)

**File:** `src/config/settings.py`

**구현:**
```python
from pydantic import Field, field_validator
import warnings

class Settings(BaseSettings):
    # ... 기존 필드 ...

    # DEV_MODE: Development mode flag
    dev_mode: bool = Field(
        default=False,
        alias="DEV_MODE",
        description="Enable development mode (localhost auth bypass, test utilities)"
    )

    @field_validator('dev_mode')
    @classmethod
    def warn_dev_mode(cls, v: bool) -> bool:
        """Warn when DEV_MODE is enabled (security risk)"""
        if v:
            warnings.warn(
                "DEV_MODE is enabled. This bypasses security for localhost requests. "
                "DO NOT use in production!",
                UserWarning,
                stacklevel=2
            )
        return v
```

**테스트 검증:**
- `test_dev_mode_false_by_default`: default=False
- `test_dev_mode_true_from_env`: alias="DEV_MODE"
- `test_dev_mode_validation`: pydantic bool parsing
- `test_dev_mode_warns_when_enabled`: field_validator

**Edge Cases:**
- "true", "True", "1", "yes" → True (pydantic)
- "false", "False", "0", "no" → False
- 잘못된 값 → ValidationError

### Step 2: test_utils 라우터 조건부 등록 (TDD GREEN)

**File:** `src/adapters/inbound/http/app.py`

**구현:**
```python
def create_app() -> FastAPI:
    # ... 기존 코드 ...

    # 라우터 등록
    app.include_router(auth.router)
    # ... 기존 라우터들 ...
    app.include_router(usage.router)

    # DEV_MODE: Conditional test utilities
    settings = container.settings()
    if settings.dev_mode:
        from .routes import test_utils
        app.include_router(test_utils.router)
        logger.warning("Test utilities enabled (/test/*) - DEV_MODE only")

    return app
```

**테스트 검증:**
- `test_state_endpoint_returns_correct_structure`: 200 + 올바른 JSON 구조
- `test_reset_data_endpoint_returns_correct_structure`: 200 + reset_complete
- `test_reset_data_is_idempotent`: 2회 호출 시 두 번째는 0 카운트

**보안:**
- DEV_MODE=false: `/test/*` 404 반환
- `/test/reset-data`: 모든 MCP/A2A/대화 삭제 (프로덕션 위험)

### Step 3: REFACTOR - os.getenv → Settings.dev_mode

**File:** `src/adapters/inbound/http/app.py` (lines 156-158)

**Before:**
```python
dev_mode = os.getenv("DEV_MODE", "false").lower() == "true"
cors_config = get_cors_config(dev_mode=dev_mode)
```

**After:**
```python
settings = container.settings()
cors_config = get_cors_config(dev_mode=settings.dev_mode)
```

**Rationale:** 중앙화된 설정, 단일 진실 원천

**File:** `src/adapters/inbound/http/security.py` (line 91)

**변경 없음:**
```python
# DEV_MODE: localhost Origin 또는 Origin 없음 → 인증 우회
dev_mode = os.getenv("DEV_MODE", "false").lower() == "true"
```

**이유:** ExtensionAuthMiddleware는 DI Container 접근 불가 (app context 외부)

**대안 검토:**
1. ✅ os.getenv 유지 (pragmatic, 문서화)
2. ❌ Settings를 middleware constructor에 전달 (app.py 대규모 리팩토링)
3. ❌ app.state로 settings 공유 (lifespan 변경 필요)

**결정:** os.getenv 유지 (middleware DI 한계, ADR에 기록)

### Step 4: 문서화 (Critical)

#### 4.1 ADR-T09 작성 (NEW)

**File:** `docs/project/decisions/technical/ADR-T09-dev-mode-conditional-endpoints.md`

**내용:**
- **Status:** Accepted
- **Context:** E2E 테스트를 위한 `/test/*` 엔드포인트 필요, 프로덕션 노출 위험
- **Decision:** DEV_MODE 조건부 라우터 등록
- **Consequences:** 보안 향상, 개발 편의성 유지
- **Alternatives:**
  - Always-on (보안 위험)
  - Separate test server (E2E 복잡도 증가)

#### 4.2 Security Guide 업데이트

**File:** `docs/operators/security/README.md`

**추가 섹션:**
```markdown
## DEV_MODE Security Impact

**⚠️ WARNING:** DEV_MODE bypasses Drive-by RCE protection.

- Localhost requests skip token authentication
- `/test/*` endpoints expose data deletion API
- **NEVER** enable DEV_MODE in production

**Verification:**
echo $DEV_MODE  # Should be unset or "false"
```

#### 4.3 Deployment Guide 업데이트

**File:** `docs/operators/deployment/README.md`

**환경변수 표에 추가:**
| Variable | Default | Description |
|----------|---------|-------------|
| DEV_MODE | false | Enable development mode (NEVER use in production) |

#### 4.4 Technical Decisions Index 업데이트

**File:** `docs/project/decisions/technical/README.md`

**추가:**
- ADR-T09: DEV_MODE Conditional Endpoints (2026-02-07)


#### 4.5 추가 업데이트

- README.md Quick Start
- tests/docs/WritingGuide.md
- tests/docs/CONFIGURATION.md
- Code Docstrings 명시적 언급

### Step 5: 검증

**5.1 DEV_MODE 테스트:**
```bash
pytest tests/integration/adapters/ -k dev_mode -v --tb=short
```

**예상 결과:** 32개 테스트 전체 PASS
- test_dev_mode_settings.py: 4/4
- test_dev_mode_test_utils.py: 3/3
- test_dev_mode_cors.py: 12/12
- test_dev_mode_security.py: 13/13

**5.2 E2E 테스트:**
```bash
pytest tests/e2e/test_playground.py::TestCleanState -v
```

**예상 결과:** clean_state fixture 정상 작동 (/test/reset-data 사용)

**5.3 전체 테스트 Suite:**
```bash
pytest -x --tb=line -q
```

**예상 결과:** GREEN baseline 복구

**5.4 Coverage:**
```bash
pytest --cov=src --cov-fail-under=80 -q
```

**예상 결과:** >= 80%

**5.5 문서 검증:**
```bash
python scripts/validate_docs.py
```

## Critical Files

| File | Purpose | Changes |
|------|---------|---------|
| `src/config/settings.py` | Settings.dev_mode 추가 | +15 lines |
| `src/adapters/inbound/http/app.py` | 조건부 라우터 + refactor | ~10 lines |
| `docs/project/decisions/technical/ADR-T09-dev-mode-conditional-endpoints.md` | 신규 ADR | NEW |
| `docs/operators/security/README.md` | 보안 영향 설명 | ~10 lines |
| `docs/operators/deployment/README.md` | 환경변수 추가 | +1 line |
| `docs/project/decisions/technical/README.md` | ADR 인덱스 업데이트 | +1 line |

## Commit Strategy

**단일 Atomic Commit:**
```
feat: implement DEV_MODE settings and conditional test utilities

TDD Green Phase:
- Add Settings.dev_mode field with validation and UserWarning
- Register test_utils router conditionally (DEV_MODE=true only)

Refactor:
- Replace os.getenv("DEV_MODE") with Settings.dev_mode in app.py
- Keep os.getenv in security.py (middleware DI limitation, documented in ADR-T09)

Documentation:
- Add ADR-T09: DEV_MODE Conditional Endpoints
- Update Security Guide with DEV_MODE warnings
- Update Deployment Guide with DEV_MODE env var

Fixes:
- test_dev_mode_settings.py: 4 tests now passing
- test_dev_mode_test_utils.py: 3 tests now passing
- Restores GREEN baseline from commit 501ccef

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

**Rationale:**
- 단일 기능 (DEV_MODE 구현)
- TDD 전체 사이클 완성 (Red → Green → Refactor)
- 문서화 포함 (Critical security impact)
- Atomic recovery (working state 복원)

## Potential Issues & Mitigations

### Issue 1: Settings Singleton Caching

**Problem:** 테스트가 DEV_MODE 환경변수 수정 시 Settings 싱글톤이 이전 값 캐싱
**Mitigation:**
- 테스트는 monkeypatch + `create_app()` 사용 (Settings 재로드)
- Fixtures에서 `container.reset_singletons()` 호출

### Issue 2: Middleware DI Limitation

**Problem:** ExtensionAuthMiddleware는 DI Container 접근 불가
**Decision:** os.getenv 유지 (ADR-T09에 기록)
**Trade-off:** 일관성 vs 복잡도

### Issue 3: pydantic Bool Parsing

**True:** "true", "True", "1", "yes", "on"
**False:** "false", "False", "0", "no", "off"
**Invalid:** ValidationError
**Test:** test_dev_mode_validation 커버

## Success Criteria

- [ ] **Baseline 회귀 테스트**: `pytest -q --tb=line` (Phase 시작 전 Green 상태 확인)
- [ ] Settings.dev_mode 필드 구현 ✓ field_validator 포함
- [ ] test_utils 라우터 조건부 등록 ✓ DEV_MODE=true만
- [ ] os.getenv → Settings.dev_mode refactor ✓ app.py만 (security.py 제외)
- [ ] ADR-T09 작성 ✓ 조건부 엔드포인트 결정 기록
- [ ] Security Guide 업데이트 ✓ DEV_MODE 경고
- [ ] Deployment Guide 업데이트 ✓ 환경변수 표
- [ ] 추가 문서 업데이트 완료
- [ ] 32개 dev_mode 테스트 전체 PASS
- [ ] E2E test_playground.py PASS
- [ ] 전체 테스트 Suite GREEN
- [ ] Coverage >= 80%
- [ ] 문서 검증 PASS
