# Playground E2E 테스트 실패 수정 계획

## Context

Plan 08 Phase 6 (E2E Tests)에서 Playground 테스트 26개 중 5개가 실패합니다.
근본 원인을 분석한 결과 **백엔드 2건 + 프론트엔드 2건 + 잠재 버그 1건** = 총 5개 버그를 발견했습니다.

**목표:** 5개 실패 테스트를 모두 Green으로 전환하고, 기존 통과 테스트(unit/integration/E2E)가 깨지지 않도록 합니다.

---

## 발견한 버그 요약

| # | 카테고리 | 실패 테스트 | 근본 원인 |
|---|---------|------------|-----------|
| 1 | Backend | `test_workflow_execution_sse_streaming`, `test_workflow_result_visualization` | `chunk.metadata` AttributeError (StreamChunk에 없는 속성) |
| 2 | Backend | `test_budget_set_and_retrieved` | CORS `allow_methods`에 `"PUT"` 누락 |
| 3 | Frontend | `test_conversation_tool_calls_displayed` | Tool calls 미구현 (빈 div → invisible) |
| 4 | Frontend (latent) | (테스트 통과하지만 DB 데이터 불일치) | `createConversation`이 `{name}` 전송, 백엔드는 `{title}` 기대 |
| 5 | E2E Test | `test_workflow_execution_sse_streaming` | SSE 이벤트 타입명 불일치 (`workflow_started` vs `workflow_start`) |

---

## 수정 계획

### Bug 1: Workflow StreamChunk.metadata AttributeError (2 E2E tests)

**근본 원인:** `workflow.py`에서 `chunk.metadata`를 접근하지만, `StreamChunk`에는 `metadata` 속성이 없음

**영향 위치:**
- `src/adapters/inbound/http/routes/workflow.py:205-206` (`execute_workflow_get`)
- `src/adapters/inbound/http/routes/workflow.py:354-355` (`execute_workflow`)

**수정 방법:** `ChatStreamEvent` 패턴을 따라 `WorkflowStreamEvent` 스키마 생성

**파일 변경:**

1. `src/adapters/inbound/http/schemas/workflow.py` - `WorkflowStreamEvent` 추가:
   ```python
   class WorkflowStreamEvent(BaseModel):
       type: str
       workflow_id: str
       content: str | None = None
       tool_name: str | None = None
       tool_arguments: dict | None = None
       result: str | None = None
       agent_name: str | None = None
       error_code: str | None = None
       workflow_type: str | None = None
       workflow_status: str | None = None
       step_number: int | None = None
       total_steps: int | None = None

       @classmethod
       def from_stream_chunk(cls, chunk: StreamChunk, workflow_id: str) -> "WorkflowStreamEvent":
           # StreamChunk 필드를 직접 매핑 (metadata 사용 안함)
   ```

2. `src/adapters/inbound/http/routes/workflow.py` - 두 곳 모두 수정:
   ```python
   # Before (broken):
   if chunk.metadata:
       event_data.update(chunk.metadata)

   # After (safe):
   event = WorkflowStreamEvent.from_stream_chunk(chunk, workflow_id)
   event_data = event.model_dump(exclude_none=True)
   yield f"data: {json.dumps(event_data)}\n\n"
   ```

**참고 패턴:** `src/adapters/inbound/http/schemas/chat.py:28-50` (`ChatStreamEvent.from_stream_chunk`)

---

### Bug 2: CORS `allow_methods`에 PUT 누락 (1 E2E test)

**근본 원인:** `allow_methods`에 `"PUT"`이 없어서 `PUT /api/usage/budget` 요청이 CORS preflight에서 차단됨

**증거:**
- `allow_methods: ["GET", "POST", "DELETE", "OPTIONS"]` ← PUT 없음
- `setBudget()` → `fetchPut()` → `PUT /api/usage/budget` ← 유일한 PUT 엔드포인트
- 프론트엔드 `catch (e) { console.error(e) }` → 에러 무시 → display 빈 상태

**파일 변경:**
- `src/adapters/inbound/http/app.py:47`
  ```python
  # Before:
  "allow_methods": ["GET", "POST", "DELETE", "OPTIONS"],
  # After:
  "allow_methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
  ```

---

### Bug 3: Tool Calls 미구현 (1 E2E test)

**근본 원인:**
1. `api-client.js`에 `getToolCalls(conversationId)` 함수 없음
2. "Tool Calls" 버튼 핸들러가 API 호출 없이 빈 div만 `display:block` 설정
3. 빈 div는 높이가 0 → Playwright `to_be_visible()` = false
4. conversation ID가 DOM에 저장되지 않음

**파일 변경:**

1. `tests/manual/playground/js/api-client.js` - `getToolCalls` 함수 추가:
   ```javascript
   export async function getToolCalls(conversationId) {
       return fetchGet(`${API_BASE}/api/conversations/${conversationId}/tool-calls`);
   }
   ```

2. `tests/manual/playground/js/main.js` - `initConversationsHandlers()` 수정:
   - conversation ID를 DOM element의 `data-conversation-id` 속성에 저장
   - "Tool Calls" 버튼 핸들러에서 `getToolCalls(id)` 호출
   - 결과 렌더링 (빈 경우 "No tool calls" 메시지)

3. `tests/manual/playground/js/main.js` - import에 `getToolCalls` 추가

**백엔드 확인:** `GET /api/conversations/{id}/tool-calls` 엔드포인트 이미 존재 (`conversations.py:53-80`)

---

### Bug 4: createConversation 필드명 불일치 (latent)

**근본 원인:** 프론트엔드가 `{ name }` 전송, 백엔드 `CreateConversationRequest`는 `title` 기대 → 항상 빈 title로 생성됨

**파일 변경:**
- `tests/manual/playground/js/api-client.js:116`
  ```javascript
  // Before:
  return fetchPost(`${API_BASE}/api/conversations`, { name });
  // After:
  return fetchPost(`${API_BASE}/api/conversations`, { title: name });
  ```

**JS Unit Test 업데이트 필요:**
- `tests/manual/playground/tests/api-client.test.js:241`
  ```javascript
  // Before:
  body: JSON.stringify({ name: "Test Conv" })
  // After:
  body: JSON.stringify({ title: "Test Conv" })
  ```

---

### Bug 5: E2E 테스트 Workflow 이벤트 타입명 불일치

**상황:**
- Domain Entity (`StreamChunk`): `type="workflow_start"`, `type="workflow_complete"`
- Unit Tests: `workflow_start`, `workflow_complete` ← 통과 중
- Integration Tests: `workflow_start`, `workflow_complete` ← 통과 중
- E2E Test: `"workflow_started"`, `"workflow_completed"` ← Red Phase (미통과)
- Frontend (`main.js`): `data.type === "workflow_completed"` ← Red Phase 기준

**결정:** E2E 테스트와 프론트엔드를 **기존 도메인 타입에 맞춤** (원칙: 이미 통과하는 unit/integration 테스트가 ground truth)

**파일 변경:**

1. `tests/e2e/test_playground.py:599-600`
   ```python
   # Before:
   expect(sse_log).to_contain_text('"type":"workflow_started"')
   expect(sse_log).to_contain_text('"type":"workflow_completed"')
   # After:
   expect(sse_log).to_contain_text('"type":"workflow_start"')
   expect(sse_log).to_contain_text('"type":"workflow_complete"')
   ```

2. `tests/manual/playground/js/main.js:269`
   ```javascript
   // Before:
   if (data.type === "workflow_completed") {
   // After:
   if (data.type === "workflow_complete") {
   ```

---

## 구현 순서

TDD 원칙에 따라 **백엔드 → 프론트엔드** 순서로 진행:

1. **Step 1: CORS PUT 추가** (Bug 2) - 1줄 수정
2. **Step 2: WorkflowStreamEvent 스키마 생성** (Bug 1) - 새 스키마 + route 수정
3. **Step 3: E2E 이벤트 타입 정렬** (Bug 5) - E2E test + frontend 수정
4. **Step 4: createConversation 필드명** (Bug 4) - api-client + JS unit test 수정
5. **Step 5: Tool Calls 구현** (Bug 3) - api-client + main.js 수정
6. **Step 6: 전체 검증**

---

## 수정 대상 파일 총 목록

| 파일 | Bug # | 변경 내용 |
|------|-------|-----------|
| `src/adapters/inbound/http/app.py` | 2 | PUT 추가 |
| `src/adapters/inbound/http/schemas/workflow.py` | 1 | WorkflowStreamEvent 추가 |
| `src/adapters/inbound/http/routes/workflow.py` | 1 | chunk.metadata → WorkflowStreamEvent |
| `tests/manual/playground/js/api-client.js` | 3,4 | getToolCalls 추가, title 필드 수정 |
| `tests/manual/playground/js/main.js` | 3,5 | tool calls 핸들러, workflow type |
| `tests/e2e/test_playground.py` | 5 | workflow type 정렬 |
| `tests/manual/playground/tests/api-client.test.js` | 4 | createConversation body 수정 |

---

## 검증 방법

```bash
# 1. 기존 단위/통합 테스트 확인 (깨지지 않아야 함)
.venv/Scripts/python.exe -m pytest tests/unit tests/integration -q --tb=line -x

# 2. Playground E2E 전체 테스트
.venv/Scripts/python.exe -m pytest tests/e2e/test_playground.py -v --timeout=120 -m ""

# 3. JS Unit Tests (선택)
cd tests/manual/playground && npm test

# 4. Coverage 확인
.venv/Scripts/python.exe -m pytest --cov=src --cov-fail-under=80 -q
```

**목표:** 26개 Playground E2E 테스트 중 25개 통과 (1개는 의도적 스킵)
