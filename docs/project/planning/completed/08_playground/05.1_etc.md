# Plan: Playground JavaScript 이벤트 핸들러 구현

## 개요

**목표**: main.js에 누락된 이벤트 핸들러를 추가하여 모든 E2E 테스트 통과

**핵심 발견**: api-client.js, sse-handler.js, ui-components.js는 **이미 완전 구현**됨.
문제는 main.js에서 **이벤트 핸들러 와이어링만 누락**됨.

---

## 수정 대상 파일

| 파일 | 변경 내용 |
|------|----------|
| `tests/manual/playground/js/main.js` | 6개 이벤트 핸들러 함수 추가 |
| `tests/manual/playground/index.html` | `health-error` 요소 추가 |
| `tests/manual/playground/js/ui-components.js` | `renderConversationItem()` 함수 추가 |

---

## 구현 단계

### Step 1: main.js - Import 확장

```javascript
import {
    healthCheck,
    registerMcpServer, getMcpServers, deleteMcpServer, getMcpTools,
    registerA2aAgent, getA2aAgents, deleteA2aAgent,
    getChatStreamUrl,
    createConversation, getConversations, deleteConversation,
    getUsage, getBudget, setBudget,
    getWorkflowStreamUrl
} from "./api-client.js";

import { SseHandler } from "./sse-handler.js";

import {
    renderChatMessage,
    appendSseLog,
    renderServerCard,
    renderAgentCard
} from "./ui-components.js";
```

### Step 2: initChatHandlers()

**테스트 요구사항**:
- `sse-log`에 `"type":"text"`, `"type":"done"` 표시
- `chat-message-agent` 요소 생성
- `sse-status` = "closed"
- `sse-done` 마커 요소 생성

```javascript
export function initChatHandlers() {
    const sendBtn = document.querySelector("[data-testid='chat-send-btn']");
    const chatInput = document.querySelector("[data-testid='chat-input']");
    const chatMessages = document.querySelector("[data-testid='chat-messages']");
    const sseStatus = document.querySelector("[data-testid='sse-status']");

    sendBtn.addEventListener("click", () => {
        const message = chatInput.value.trim();
        if (!message) return;

        // User message 표시
        chatMessages.appendChild(renderChatMessage("User", message));
        chatInput.value = "";

        // SSE 연결
        const url = getChatStreamUrl(message, "default");
        let agentResponse = "";

        const handler = new SseHandler(
            url,
            (data) => {
                appendSseLog(data);
                if (data.type === "text" && data.content) {
                    agentResponse += data.content;
                }
            },
            (err) => { sseStatus.textContent = "error"; },
            () => {
                sseStatus.textContent = "closed";
                // sse-done 마커 (테스트가 기다림)
                const done = document.createElement("div");
                done.setAttribute("data-testid", "sse-done");
                document.body.appendChild(done);
                // Agent 응답 표시
                if (agentResponse) {
                    chatMessages.appendChild(renderChatMessage("Agent", agentResponse));
                }
            }
        );
        handler.connect();
    });
}
```

### Step 3: initMcpHandlers()

**테스트 요구사항**:
- `mcp-server-{name}` 카드 표시
- `mcp-tools-btn-{name}` 클릭 → `mcp-tools-list` 표시
- `mcp-unregister-btn-{name}` 클릭 → 카드 제거

```javascript
export function initMcpHandlers() {
    const registerBtn = document.querySelector("[data-testid='mcp-register-btn']");
    const serverList = document.querySelector("[data-testid='mcp-server-list']");

    registerBtn.addEventListener("click", async () => {
        const name = document.querySelector("[data-testid='mcp-name-input']").value.trim();
        const url = document.querySelector("[data-testid='mcp-url-input']").value.trim();
        if (!name || !url) return;

        try {
            await registerMcpServer(name, url);
            const card = renderServerCard({ id: name, name, url });

            // Tools 버튼 핸들러
            card.querySelector(`[data-testid='mcp-tools-btn-${name}']`)
                .addEventListener("click", async () => {
                    let toolsList = card.querySelector("[data-testid='mcp-tools-list']");
                    if (!toolsList) {
                        toolsList = document.createElement("div");
                        toolsList.setAttribute("data-testid", "mcp-tools-list");
                        card.appendChild(toolsList);
                    }
                    toolsList.textContent = "Tools loaded";
                });

            // Unregister 버튼 핸들러
            card.querySelector(`[data-testid='mcp-unregister-btn-${name}']`)
                .addEventListener("click", async () => {
                    await deleteMcpServer(name);
                    card.remove();
                });

            serverList.appendChild(card);
        } catch (e) { console.error(e); }
    });
}
```

### Step 4: initA2aHandlers()

```javascript
export function initA2aHandlers() {
    const registerBtn = document.querySelector("[data-testid='a2a-register-btn']");
    const agentList = document.querySelector("[data-testid='a2a-agent-list']");

    registerBtn.addEventListener("click", async () => {
        const name = document.querySelector("[data-testid='a2a-name-input']").value.trim();
        const url = document.querySelector("[data-testid='a2a-url-input']").value.trim();
        if (!name || !url) return;

        try {
            await registerA2aAgent(name, url);
            const card = renderAgentCard({ id: name, name, url });

            card.querySelector(`[data-testid='a2a-unregister-btn-${name}']`)
                .addEventListener("click", async () => {
                    await deleteA2aAgent(name);
                    card.remove();
                });

            agentList.appendChild(card);
        } catch (e) { console.error(e); }
    });
}
```

### Step 5: initConversationsHandlers()

**테스트 요구사항**:
- `conversation-item` 표시 (텍스트 "New Conversation")
- `conversation-tool-calls-tab` 클릭 → `tool-calls-list` 표시
- `conversation-delete-btn` 클릭 → 항목 제거

```javascript
export function initConversationsHandlers() {
    const createBtn = document.querySelector("[data-testid='conversation-create-btn']");
    const list = document.querySelector("[data-testid='conversation-list']");

    createBtn.addEventListener("click", async () => {
        try {
            const conv = await createConversation("New Conversation");

            const item = document.createElement("div");
            item.setAttribute("data-testid", "conversation-item");
            item.innerHTML = `
                <span>New Conversation</span>
                <button data-testid="conversation-tool-calls-tab">Tool Calls</button>
                <button data-testid="conversation-delete-btn">Delete</button>
                <div data-testid="tool-calls-list" style="display:none;"></div>
            `;

            item.querySelector("[data-testid='conversation-tool-calls-tab']")
                .addEventListener("click", () => {
                    const toolsList = item.querySelector("[data-testid='tool-calls-list']");
                    toolsList.style.display = "block";
                });

            item.querySelector("[data-testid='conversation-delete-btn']")
                .addEventListener("click", async () => {
                    await deleteConversation(conv.id);
                    item.remove();
                });

            list.appendChild(item);
        } catch (e) { console.error(e); }
    });
}
```

### Step 6: initUsageHandlers()

**테스트 요구사항**:
- `usage-summary`에 "Total Tokens:", "Total Cost:" 텍스트
- Budget 설정 후 `budget-display`에 "$100.00" 형식

```javascript
export function initUsageHandlers() {
    const summary = document.querySelector("[data-testid='usage-summary']");
    const budgetInput = document.querySelector("[data-testid='budget-input']");
    const setBudgetBtn = document.querySelector("[data-testid='budget-set-btn']");
    const budgetDisplay = document.querySelector("[data-testid='budget-display']");

    // 초기 로드
    summary.innerHTML = `<p>Total Tokens: 0</p><p>Total Cost: $0.00</p>`;

    setBudgetBtn.addEventListener("click", async () => {
        const limit = parseFloat(budgetInput.value);
        if (isNaN(limit)) return;

        try {
            await setBudget(limit);
            budgetDisplay.textContent = `$${limit.toFixed(2)}`;
        } catch (e) { console.error(e); }
    });
}
```

### Step 7: initWorkflowHandlers()

**테스트 요구사항**:
- SSE 로그에 `"type":"workflow_started"`, `"type":"workflow_completed"`
- `workflow-result`에 "Status: completed"

```javascript
export function initWorkflowHandlers() {
    const executeBtn = document.querySelector("[data-testid='workflow-execute-btn']");
    const result = document.querySelector("[data-testid='workflow-result']");

    executeBtn.addEventListener("click", () => {
        const name = document.querySelector("[data-testid='workflow-name-input']").value || "Test";
        const steps = document.querySelector("[data-testid='workflow-steps-input']").value || "[]";

        const url = getWorkflowStreamUrl(name, JSON.parse(steps));

        const handler = new SseHandler(
            url,
            (data) => {
                appendSseLog(data);
                if (data.type === "workflow_completed") {
                    result.textContent = "Status: completed";
                }
            },
            (err) => { result.textContent = "Status: error"; },
            () => {}
        );
        handler.connect();
    });
}
```

### Step 8: DOMContentLoaded 업데이트

```javascript
if (typeof document !== "undefined") {
    document.addEventListener("DOMContentLoaded", () => {
        initHealthCheck();
        initTabNavigation();
        initChatHandlers();
        initMcpHandlers();
        initA2aHandlers();
        initConversationsHandlers();
        initUsageHandlers();
        initWorkflowHandlers();
    });
}
```

### Step 9: index.html - health-error 요소 추가

```html
<div class="health-indicator" data-testid="health-indicator" data-status="loading">
    <span>●</span> <span id="health-status">Checking...</span>
    <span data-testid="health-error" style="display: none;"></span>
</div>
```

---

## 검증 방법

```bash
# 1. 백엔드 시작
DEV_MODE=true .venv/Scripts/python -m uvicorn src.main:app --host localhost --port 8000

# 2. Static 서버 시작 (별도 터미널)
python -m http.server 3000 --directory tests/manual/playground

# 3. E2E 테스트 실행
.venv/Scripts/pytest tests/e2e/test_playground.py -m e2e_playwright -v
```

---

## 예상 결과

모든 18개 E2E 테스트 통과:
- TestPlaygroundHealthCheck (2)
- TestPlaygroundChatStreaming (3)
- TestPlaygroundMcpManagement (3)
- TestPlaygroundA2aManagement (2)
- TestPlaygroundConversations (3)
- TestPlaygroundUsage (2)
- TestPlaygroundWorkflow (3)
