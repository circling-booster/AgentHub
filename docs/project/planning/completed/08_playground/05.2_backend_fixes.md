# Phase 5.2: Backend API Fixes for Playground

## Overview

**ëª©í‘œ:** E2E í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì›ì¸ì¸ ë°±ì—”ë“œ API ëˆ„ë½/ë¶ˆì¼ì¹˜ í•´ê²°

**ë°œê²¬ ê²½ìœ„:** Phase 5.1 (í”„ë¡ íŠ¸ì—”ë“œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬) êµ¬í˜„ í›„ E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œ ë°œê²¬

**TDD ì›ì¹™:** Red â†’ Green â†’ Refactor ìˆœì„œ ì—„ìˆ˜

---

## ë¬¸ì œ ìš”ì•½

| ë¬¸ì œ | í˜„ì¬ ìƒíƒœ | í•„ìš” ìƒíƒœ | ìš°ì„ ìˆœìœ„ | ì˜í–¥ í…ŒìŠ¤íŠ¸ |
|------|----------|----------|---------|-----------|
| **Chat SSE GET ì—”ë“œí¬ì¸íŠ¸ ëˆ„ë½** | POSTë§Œ ìˆìŒ | GET ì¶”ê°€ í•„ìš” | ğŸ”´ High | Chat Streaming (3ê°œ) |
| **Conversations DELETE ëˆ„ë½** | DELETE ì—†ìŒ | DELETE ì¶”ê°€ í•„ìš” | ğŸ”´ High | Conversations (1ê°œ) |
| **Workflow Execute URL** | POST /{id}/execute | GET /execute ë˜ëŠ” ìˆ˜ì • | ğŸŸ¡ Medium | Workflow (2ê°œ) |

---

## 1. GET /api/chat/stream (ìš°ì„ ìˆœìœ„: ğŸ”´ High)

### ë¬¸ì œ ìƒì„¸

**í˜„ì¬:**
- `POST /api/chat/stream` (body: JSON)
- StreamingResponse with SSE

**ë¬¸ì œ:**
- ë¸Œë¼ìš°ì € EventSourceëŠ” GETë§Œ ì§€ì›
- í”„ë¡ íŠ¸ì—”ë“œ sse-handler.jsê°€ EventSource ì‚¬ìš©

**í•´ê²°ì±…:**
- GET ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
- Query parameters: `message`, `conversation_id`
- ê¸°ì¡´ POST ë¡œì§ ì¬ì‚¬ìš©

### Step 1.1: Red - GET ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ ì‘ì„±

**í…ŒìŠ¤íŠ¸ íŒŒì¼:** `tests/integration/adapters/test_chat_routes.py`

```python
class TestChatStreamingGET:
    """GET /api/chat/stream - EventSource ì§€ì›"""

    def test_chat_stream_get_basic(self, authenticated_client):
        """Red: GET ë©”ì„œë“œë¡œ SSE ìŠ¤íŠ¸ë¦¬ë°"""
        # Given: Query parameters
        params = {
            "message": "Say hello",
            "conversation_id": None
        }

        # When: GET ìš”ì²­
        with authenticated_client.stream("GET", "/api/chat/stream", params=params) as response:
            # Then: 200 OK, SSE ìŠ¤íŠ¸ë¦¬ë°
            assert response.status_code == status.HTTP_200_OK
            assert response.headers["content-type"] == "text/event-stream; charset=utf-8"

            events = []
            for line in response.iter_lines():
                if line.startswith("data: "):
                    events.append(json.loads(line[6:]))

            assert len(events) >= 1
            assert events[-1]["type"] == "done"

    def test_chat_stream_get_with_conversation_id(self, authenticated_client):
        """Red: conversation_idë¥¼ query paramìœ¼ë¡œ ì „ë‹¬"""
        # Given: ëŒ€í™” ìƒì„±
        conv_response = authenticated_client.post(
            "/api/conversations", json={"title": "Test"}
        )
        conv_id = conv_response.json()["id"]

        params = {
            "message": "Hello",
            "conversation_id": conv_id
        }

        # When: GET ìš”ì²­
        with authenticated_client.stream("GET", "/api/chat/stream", params=params) as response:
            # Then: 200 OK
            assert response.status_code == status.HTTP_200_OK

    def test_chat_stream_get_empty_message_validation(self, authenticated_client):
        """Red: ë¹ˆ ë©”ì‹œì§€ ê²€ì¦"""
        # Given: ë¹ˆ ë©”ì‹œì§€
        params = {"message": ""}

        # When: GET ìš”ì²­
        response = authenticated_client.get("/api/chat/stream", params=params)

        # Then: 422 Validation Error
        assert response.status_code == status.HTTP_422_UNPROCESSABLE_ENTITY
```

### Step 1.2: Green - GET ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„

**íŒŒì¼:** `src/adapters/inbound/http/routes/chat.py`

```python
from fastapi import Query

@router.get("/stream")
@inject
async def chat_stream_get(
    request: Request,
    message: str = Query(..., min_length=1, description="Chat message"),
    conversation_id: str | None = Query(None, description="Conversation ID (optional)"),
    orchestrator: OrchestratorService = Depends(Provide[Container.orchestrator_service]),
):
    """
    SSE ìŠ¤íŠ¸ë¦¬ë° ì±„íŒ… (GET - EventSource ì§€ì›)

    Args:
        request: FastAPI Request
        message: ì±„íŒ… ë©”ì‹œì§€ (query parameter)
        conversation_id: ëŒ€í™” ID (optional, query parameter)
        orchestrator: OrchestratorService (DI)

    Returns:
        SSE ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ
    """
    # ChatRequest ê°ì²´ ìƒì„± (ê¸°ì¡´ ë¡œì§ ì¬ì‚¬ìš©)
    body = ChatRequest(message=message, conversation_id=conversation_id)

    # ê¸°ì¡´ POST í•¸ë“¤ëŸ¬ ë¡œì§ ì¬ì‚¬ìš© (generate í•¨ìˆ˜ ì¶”ì¶œ í›„)
    return StreamingResponse(
        generate(request, body, orchestrator),
        media_type="text/event-stream"
    )
```

**ë¦¬íŒ©í† ë§ í•„ìš”:**
- ê¸°ì¡´ `chat_stream()` í•¨ìˆ˜ì˜ `generate()` ë‚´ë¶€ í•¨ìˆ˜ë¥¼ ë³„ë„ í•¨ìˆ˜ë¡œ ì¶”ì¶œ
- POSTì™€ GET ëª¨ë‘ ë™ì¼í•œ `generate()` í•¨ìˆ˜ ì‚¬ìš©

### Step 1.3: Refactor - ì¤‘ë³µ ì½”ë“œ ì œê±°

```python
async def _generate_chat_stream(
    request: Request,
    body: ChatRequest,
    orchestrator: OrchestratorService
) -> AsyncIterator[str]:
    """ê³µí†µ SSE ì´ë²¤íŠ¸ ìƒì„±ê¸°"""
    conversation_id = body.conversation_id
    chunk_count = 0

    try:
        # ... (ê¸°ì¡´ generate ë¡œì§)
        pass
    except Exception as e:
        # ... (ì—ëŸ¬ ì²˜ë¦¬)
        pass


@router.post("/stream")
@inject
async def chat_stream(
    request: Request,
    body: ChatRequest,
    orchestrator: OrchestratorService = Depends(Provide[Container.orchestrator_service]),
):
    """POST - JSON body"""
    return StreamingResponse(
        _generate_chat_stream(request, body, orchestrator),
        media_type="text/event-stream"
    )


@router.get("/stream")
@inject
async def chat_stream_get(
    request: Request,
    message: str = Query(..., min_length=1),
    conversation_id: str | None = Query(None),
    orchestrator: OrchestratorService = Depends(Provide[Container.orchestrator_service]),
):
    """GET - Query parameters (EventSource ì§€ì›)"""
    body = ChatRequest(message=message, conversation_id=conversation_id)
    return StreamingResponse(
        _generate_chat_stream(request, body, orchestrator),
        media_type="text/event-stream"
    )
```

---

## 2. DELETE /api/conversations/{id} (ìš°ì„ ìˆœìœ„: ğŸ”´ High)

### ë¬¸ì œ ìƒì„¸

**í˜„ì¬:**
- POST /api/conversations (ìƒì„±) âœ…
- GET /api/conversations (ëª©ë¡) âœ…
- GET /api/conversations/{id}/tool-calls (ë„êµ¬ í˜¸ì¶œ) âœ…
- DELETE /api/conversations/{id} âŒ

**í•„ìš”:**
- Conversation ì‚­ì œ ì—”ë“œí¬ì¸íŠ¸

### Step 2.1: Red - DELETE ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ ì‘ì„±

**í…ŒìŠ¤íŠ¸ íŒŒì¼:** `tests/integration/adapters/test_conversations_routes.py`

```python
class TestConversationDeletion:
    """DELETE /api/conversations/{id}"""

    def test_delete_conversation_success(self, authenticated_client):
        """Red: ëŒ€í™” ì‚­ì œ ì„±ê³µ"""
        # Given: ëŒ€í™” ìƒì„±
        response = authenticated_client.post(
            "/api/conversations", json={"title": "Test Conversation"}
        )
        conversation_id = response.json()["id"]

        # When: ëŒ€í™” ì‚­ì œ
        delete_response = authenticated_client.delete(
            f"/api/conversations/{conversation_id}"
        )

        # Then: 204 No Content
        assert delete_response.status_code == status.HTTP_204_NO_CONTENT

        # And: ëŒ€í™”ê°€ ëª©ë¡ì—ì„œ ì‚¬ë¼ì§
        list_response = authenticated_client.get("/api/conversations")
        conversations = list_response.json()
        assert conversation_id not in [c["id"] for c in conversations]

    def test_delete_conversation_not_found(self, authenticated_client):
        """Red: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ëŒ€í™” ì‚­ì œ"""
        # When: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ID ì‚­ì œ
        response = authenticated_client.delete("/api/conversations/nonexistent-id")

        # Then: 404 Not Found
        assert response.status_code == status.HTTP_404_NOT_FOUND

    def test_delete_conversation_removes_messages(self, authenticated_client):
        """Red: ëŒ€í™” ì‚­ì œ ì‹œ ë©”ì‹œì§€ë„ í•¨ê»˜ ì‚­ì œ"""
        # Given: ëŒ€í™” + ë©”ì‹œì§€ ìƒì„±
        response = authenticated_client.post(
            "/api/conversations", json={"title": "Test"}
        )
        conversation_id = response.json()["id"]

        # (ë©”ì‹œì§€ ì¶”ê°€ ë¡œì§ - orchestratorë¥¼ í†µí•´)

        # When: ëŒ€í™” ì‚­ì œ
        authenticated_client.delete(f"/api/conversations/{conversation_id}")

        # Then: Tool Callsë„ í•¨ê»˜ ì‚­ì œ
        tool_calls_response = authenticated_client.get(
            f"/api/conversations/{conversation_id}/tool-calls"
        )
        assert tool_calls_response.status_code == status.HTTP_404_NOT_FOUND
```

### Step 2.2: Green - DELETE ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„

**íŒŒì¼:** `src/adapters/inbound/http/routes/conversations.py`

```python
@router.delete("/{conversation_id}", status_code=status.HTTP_204_NO_CONTENT)
@inject
async def delete_conversation(
    conversation_id: str,
    orchestrator: OrchestratorService = Depends(Provide[Container.orchestrator_service]),
):
    """
    ëŒ€í™” ì‚­ì œ

    Args:
        conversation_id: ëŒ€í™” ID
        orchestrator: OrchestratorService (DI)

    Returns:
        204 No Content

    Raises:
        HTTPException(404): ëŒ€í™”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ
    """
    try:
        await orchestrator.delete_conversation(conversation_id)
    except ConversationNotFoundError:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Conversation {conversation_id} not found"
        )
```

### Step 2.3: Refactor - Domain Service ì¶”ê°€

**íŒŒì¼:** `src/domain/services/orchestrator_service.py`

```python
async def delete_conversation(self, conversation_id: str) -> None:
    """
    ëŒ€í™” ì‚­ì œ

    Args:
        conversation_id: ëŒ€í™” ID

    Raises:
        ConversationNotFoundError: ëŒ€í™”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ
    """
    # 1. ëŒ€í™” ì¡´ì¬ í™•ì¸
    conversation = await self._conversation_repo.get_by_id(conversation_id)
    if not conversation:
        raise ConversationNotFoundError(conversation_id)

    # 2. ëŒ€í™” ì‚­ì œ (ê´€ë ¨ ë©”ì‹œì§€/tool callsë„ CASCADE ì‚­ì œ)
    await self._conversation_repo.delete(conversation_id)
```

---

## 3. Workflow Execute Endpoint (ìš°ì„ ìˆœìœ„: ğŸŸ¡ Medium)

### ë¬¸ì œ ìƒì„¸

**í˜„ì¬:**
- POST /api/workflows/{workflow_id}/execute

**í”„ë¡ íŠ¸ì—”ë“œ ê¸°ëŒ€:**
- GET /api/workflows/execute?name=...&steps=...

**í•´ê²°ì±… 2ê°€ì§€:**

### Option A: ë°±ì—”ë“œì— GET ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€ (ê¶Œì¥)

```python
@router.get("/execute")
@inject
async def execute_workflow_stream(
    request: Request,
    name: str = Query(..., description="Workflow name"),
    steps: str = Query(..., description="JSON-encoded steps array"),
    orchestrator: OrchestratorService = Depends(Provide[Container.orchestrator_service]),
):
    """
    Workflow ì‹¤í–‰ (GET - EventSource ì§€ì›)

    Args:
        request: FastAPI Request
        name: Workflow ì´ë¦„
        steps: JSON ì¸ì½”ë”©ëœ steps ë°°ì—´
        orchestrator: OrchestratorService

    Returns:
        SSE ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ
    """
    # 1. Workflow ìƒì„± (ì„ì‹œ)
    steps_data = json.loads(steps)
    workflow = await orchestrator.create_workflow(name, steps_data)

    # 2. ì‹¤í–‰ (SSE)
    async def generate():
        async for event in orchestrator.execute_workflow_stream(workflow.id):
            yield f"data: {json.dumps(event)}\n\n"

    return StreamingResponse(generate(), media_type="text/event-stream")
```

### Option B: í”„ë¡ íŠ¸ì—”ë“œ ìˆ˜ì • (POST ì‚¬ìš©)

í”„ë¡ íŠ¸ì—”ë“œì—ì„œ:
1. Workflow ìƒì„± (POST /api/workflows)
2. ìƒì„±ëœ IDë¡œ ì‹¤í–‰ (POST /api/workflows/{id}/execute)

**í•˜ì§€ë§Œ EventSourceëŠ” GETë§Œ ì§€ì›í•˜ë¯€ë¡œ Option A ê¶Œì¥**

---

## ê²€ì¦ ê³„íš

### Step 1: í”„ë¡ íŠ¸ì—”ë“œ ìˆ˜ì • ì¬ê²€ì¦

```bash
# Usage API ìˆ˜ì • í™•ì¸
grep -n "api/usage" tests/manual/playground/js/api-client.js
# ê²°ê³¼: /api/usage/summary, PUT method í™•ì¸
```

### Step 2: ë°±ì—”ë“œ ìˆ˜ì • í›„ í†µí•© í…ŒìŠ¤íŠ¸

```bash
# Phase 1-2-3 ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
pytest tests/integration/adapters/test_chat_routes.py::TestChatStreamingGET -v
pytest tests/integration/adapters/test_conversations_routes.py::TestConversationDeletion -v
```

### Step 3: E2E í…ŒìŠ¤íŠ¸ ì „ì²´ ì‹¤í–‰

```bash
pytest tests/e2e/test_playground.py -m e2e_playwright -v
```

**ëª©í‘œ:** 18ê°œ í…ŒìŠ¤íŠ¸ ëª¨ë‘ PASSED

---

## êµ¬í˜„ ìˆœì„œ (TDD)

1. **Chat GET ì—”ë“œí¬ì¸íŠ¸** (ê°€ì¥ ë§ì€ í…ŒìŠ¤íŠ¸ ì˜í–¥)
   - Red: í†µí•© í…ŒìŠ¤íŠ¸ ì‘ì„±
   - Green: êµ¬í˜„
   - Refactor: ì¤‘ë³µ ì½”ë“œ ì œê±°
   - E2E: 3ê°œ í…ŒìŠ¤íŠ¸ í†µê³¼ í™•ì¸

2. **Conversations DELETE** (Conversations í…ŒìŠ¤íŠ¸ ì°¨ë‹¨ ì¤‘)
   - Red: í†µí•© í…ŒìŠ¤íŠ¸ ì‘ì„±
   - Green: êµ¬í˜„
   - Refactor: Domain Service ì¶”ê°€
   - E2E: 3ê°œ í…ŒìŠ¤íŠ¸ í†µê³¼ í™•ì¸

3. **Workflow Execute GET** (ì„ íƒì )
   - Red: í†µí•© í…ŒìŠ¤íŠ¸ ì‘ì„±
   - Green: êµ¬í˜„
   - E2E: 2ê°œ í…ŒìŠ¤íŠ¸ í†µê³¼ í™•ì¸

---

## ì˜ˆìƒ ê²°ê³¼

**Before (í˜„ì¬):**
- 1 PASSED
- 9 FAILED (Chat 3, MCP 3, A2A 2, Usage 1)
- 8 ERROR (Conversations 3, Usage 1, Workflow 2, Budget 2)

**After (í”„ë¡ íŠ¸ì—”ë“œ ìˆ˜ì •):**
- MCP, A2A: ë°±ì—”ë“œ API ìˆìœ¼ë¯€ë¡œ í†µê³¼ ì˜ˆìƒ (5ê°œ)
- Usage: API ê²½ë¡œ ìˆ˜ì •ìœ¼ë¡œ í†µê³¼ ì˜ˆìƒ (2ê°œ)
- Chat, Conversations, Workflow: ì—¬ì „íˆ ì‹¤íŒ¨ (8ê°œ)

**After (ë°±ì—”ë“œ ìˆ˜ì •):**
- 18 PASSED âœ…

---

## ê´€ë ¨ íŒŒì¼

### ë°±ì—”ë“œ
- `src/adapters/inbound/http/routes/chat.py`
- `src/adapters/inbound/http/routes/conversations.py`
- `src/adapters/inbound/http/routes/workflow.py`
- `src/domain/services/orchestrator_service.py`

### í”„ë¡ íŠ¸ì—”ë“œ (ì´ë¯¸ ìˆ˜ì • ì™„ë£Œ)
- âœ… `tests/manual/playground/js/api-client.js`
- âœ… `tests/manual/playground/js/main.js`

### í…ŒìŠ¤íŠ¸
- `tests/integration/adapters/test_chat_routes.py`
- `tests/integration/adapters/test_conversations_routes.py`
- `tests/e2e/test_playground.py`

---

## 4. ì¶”ê°€ ë°œê²¬ ì‚¬í•­ (MCP/A2A ë¶„ì„)

### 4.1 MCP ë“±ë¡ ì‹¤íŒ¨ ì›ì¸ (í•´ê²°ë¨)

**ë¬¸ì œ:**
- `mcp_synapse_server` fixtureê°€ test_playground.pyì— ì—†ì—ˆìŒ
- URL í˜•ì‹ ë¶ˆì¼ì¹˜ (`/mcp` ê²½ë¡œ ëˆ„ë½)

**í•´ê²°:**
- âœ… `playground_page` fixtureì— `mcp_synapse_server` ì˜ì¡´ì„± ì¶”ê°€
- âœ… URLì„ `http://localhost:9000/mcp`ë¡œ ìˆ˜ì •

**ì”ì—¬ ë¬¸ì œ:**
- ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œ Timeout ë°œìƒ (Synapse ì„œë²„ ì‹œì‘ ì‹œê°„)
- A2A ì„œë²„ fixture ì—†ìŒ

### 4.2 A2A ì„œë²„ Fixture í•„ìš”

**ë¬¸ì œ:**
- A2A í…ŒìŠ¤íŠ¸ì—ì„œ `http://localhost:7000` ì‚¬ìš©
- A2A ì„œë²„ fixtureê°€ conftest.pyì— ì—†ìŒ

**í•´ê²° ì˜µì…˜:**
1. A2A ì„œë²„ fixture ì¶”ê°€
2. A2A í…ŒìŠ¤íŠ¸ë¥¼ `pytest.mark.skip` ì²˜ë¦¬

### 4.3 Timeout ERROR ìˆ˜ì •

**ë¬¸ì œ:**
- Synapse ì„œë²„ ì‹œì‘ì´ ì˜¤ë˜ ê±¸ë ¤ì„œ ì´í›„ í…ŒìŠ¤íŠ¸ì—ì„œ Page.goto Timeout

**í•´ê²°:**
- fixture scopeë¥¼ `session` ë˜ëŠ” `module`ë¡œ ë³€ê²½
- ë˜ëŠ” í…ŒìŠ¤íŠ¸ timeout ì¦ê°€

---

## 5. ìˆ˜ì •ëœ í…ŒìŠ¤íŠ¸ ê²°ê³¼

**í˜„ì¬ ìƒíƒœ:**
- âœ… 1 PASSED (Health Check)
- âŒ 9 FAILED (Chat GET ì—†ìŒ, A2A fixture ì—†ìŒ)
- âŒ 8 ERROR (Timeout)

**êµ¬í˜„ ìš°ì„ ìˆœìœ„ (ì¬ì •ë ¬):**
1. **GET /api/chat/stream** (ìµœìš°ì„  - 3ê°œ í…ŒìŠ¤íŠ¸)
2. **DELETE /api/conversations/{id}** (1ê°œ í…ŒìŠ¤íŠ¸)
3. **Timeout ìˆ˜ì •** (8ê°œ í…ŒìŠ¤íŠ¸)
4. **A2A fixture** (2ê°œ í…ŒìŠ¤íŠ¸)
5. **Workflow GET** (ì„ íƒ)

---

---

## 6. E2E Test Server Blocking Issue (2026-02-06)

### 6.1 Problem Summary

E2E í…ŒìŠ¤íŠ¸ê°€ ê°œë³„ì ìœ¼ë¡œ ì‹¤í–‰í•  ë•ŒëŠ” í†µê³¼í•˜ì§€ë§Œ, ì—¬ëŸ¬ í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ë¥¼ í•¨ê»˜ ì‹¤í–‰í•  ë•Œ ì„œë²„ ë¸”ë¡œí‚¹ì´ ë°œìƒí•©ë‹ˆë‹¤.

### 6.2 Symptoms

#### í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒ¨í„´

| í…ŒìŠ¤íŠ¸ ì¡°í•© | ê²°ê³¼ |
|-------------|------|
| Chat tests only (3ê°œ) | ëª¨ë‘ PASSED |
| MCP tests only (3ê°œ) | 2 PASSED, 1 FAILED (UI issue) |
| Conversations tests only (3ê°œ) | 2 PASSED, 1 FAILED (no blocking) |
| Chat + Conversations (6ê°œ) | ëª¨ë‘ ì •ìƒ (no blocking) |
| **Chat + MCP + A2A + Conversations (11ê°œ+)** | **~10ë²ˆì§¸ í…ŒìŠ¤íŠ¸ ì´í›„ ERROR** |

#### ì—ëŸ¬ ì¦ìƒ

```
tests/e2e/test_playground.py::TestPlaygroundConversations::test_conversation_deletion[chromium] ERROR

E   playwright._impl._errors.TimeoutError: Page.goto: Timeout 30000ms exceeded.
E   Call log:
E     - navigating to "http://localhost:3000/", waiting until "domcontentloaded"
```

- `localhost:3000` (Static Server)ì— ëŒ€í•œ Page.gotoê°€ 30ì´ˆ íƒ€ì„ì•„ì›ƒ
- Backend Server (`localhost:8000`)ê°€ ì•„ë‹Œ **Static Server**ë„ ì‘ë‹µ ë¶ˆê°€
- ~10ê°œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ í›„ ë°œìƒ (í…ŒìŠ¤íŠ¸ ìˆ˜ì™€ ê´€ë ¨)

### 6.3 Investigation Details

#### ê²€í† í•œ ì½”ë“œ

| íŒŒì¼ | ëª©ì  |
|------|------|
| `src/adapters/inbound/http/routes/chat.py` | SSE Streaming êµ¬í˜„ |
| `src/adapters/inbound/http/routes/test_utils.py` | DEV_MODE cleanup API |
| `src/adapters/outbound/adk/orchestrator_adapter.py` | ADK Runner í†µí•© |
| `src/adapters/outbound/adk/dynamic_toolset.py` | MCP Toolset ê´€ë¦¬ |
| `tests/e2e/test_playground.py` | E2E í…ŒìŠ¤íŠ¸ ë° fixtures |
| `tests/conftest.py` | ê³µí†µ fixtures |

#### Fixture êµ¬ì¡° ë¶„ì„

```
playground_page (function scope)
â”œâ”€â”€ page: Page (Playwright - function scope)
â”œâ”€â”€ backend_server (module scope) - uvicorn subprocess
â”œâ”€â”€ static_server (module scope) - python -m http.server subprocess
â”œâ”€â”€ mcp_synapse_server (session scope) - MCP server subprocess
â”œâ”€â”€ a2a_echo_agent (session scope) - A2A agent subprocess
â”œâ”€â”€ playground_url (module scope) - URL string
â””â”€â”€ clean_state (function scope) - HTTP reset API call
```

#### clean_state fixture ë™ì‘

```python
def clean_state(backend_url: str, backend_server):
    """ê° í…ŒìŠ¤íŠ¸ ì „í›„ ìƒíƒœ ì´ˆê¸°í™”"""
    def _reset():
        response = httpx.post(f"{backend_url}/test/reset-data", timeout=10.0)
        # ...

    _reset()  # Setup: í…ŒìŠ¤íŠ¸ ì „
    yield
    _reset()  # Teardown: í…ŒìŠ¤íŠ¸ í›„
```

- ê° í…ŒìŠ¤íŠ¸ë§ˆë‹¤ `/test/reset-data` API 2íšŒ í˜¸ì¶œ (ì „/í›„)
- 10ê°œ í…ŒìŠ¤íŠ¸ = 20íšŒ reset-data í˜¸ì¶œ

### 6.4 Attempted Fixes (Failed)

#### Fix 1: Conversation Deletion Timeout ì¶”ê°€

**ë³€ê²½ ë‚´ìš©** (`test_utils.py`):
```python
CONVERSATION_DELETE_TIMEOUT = 1.0

for conv in conversations:
    try:
        await asyncio.wait_for(
            conversation_storage.delete_conversation(conv.id),
            timeout=CONVERSATION_DELETE_TIMEOUT,
        )
    except asyncio.TimeoutError:
        errors.append(f"Conv {conv.id}: timeout")
```

**ê²°ê³¼**: ë¬¸ì œ í•´ê²° ì•ˆë¨

#### Fix 2: Page.goto wait_until ë³€ê²½

**ë³€ê²½ ë‚´ìš©** (`test_playground.py`):
```python
# Before: page.goto(playground_url, timeout=30000)
# After:
page.goto(playground_url, timeout=30000, wait_until="domcontentloaded")
```

**ê²°ê³¼**: ë¬¸ì œ í•´ê²° ì•ˆë¨

### 6.5 Key Observations

#### Static Serverë„ ë¸”ë¡œí‚¹

- `localhost:3000`ì€ ë³„ë„ Python subprocess (`python -m http.server`)
- Backend Serverì™€ ë…ë¦½ì ì¸ í”„ë¡œì„¸ìŠ¤ì„ì—ë„ ë¶ˆêµ¬í•˜ê³  í•¨ê»˜ ì‘ë‹µ ë¶ˆê°€
- ì´ëŠ” **Python process ë ˆë²¨ì˜ ë¬¸ì œê°€ ì•„ë‹˜**ì„ ì‹œì‚¬

#### Playwright/Browser ë ˆë²¨ ì˜ì‹¬

- ì •ì  ì„œë²„ê°€ ë³„ë„ í”„ë¡œì„¸ìŠ¤ì¸ë°ë„ Page.gotoê°€ íƒ€ì„ì•„ì›ƒ
- Browser contextë‚˜ Playwright ìì²´ì˜ ë¦¬ì†ŒìŠ¤ ë¬¸ì œ ê°€ëŠ¥ì„±
- ë§ì€ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ í›„ browser ìƒíƒœ ì˜¤ì—¼ ê°€ëŠ¥ì„±

#### Subprocess ê´€ë¦¬

| Subprocess | Scope | Port |
|------------|-------|------|
| backend_server | module | 8000 |
| static_server | module | 3000 |
| mcp_synapse_server | session | 9000 |
| a2a_echo_agent | session | 9003 |

- Module scope fixturesëŠ” test_playground.py ë‚´ì—ì„œ ê³µìœ 
- Session scope fixturesëŠ” ì „ì²´ pytest ì„¸ì…˜ì—ì„œ ê³µìœ 

### 6.6 Hypotheses (To Investigate)

#### H1: Playwright Browser State ì˜¤ì—¼

- ë§ì€ í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ í›„ browser ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë˜ëŠ” ìƒíƒœ ì˜¤ì—¼
- **ê²€ì¦ ë°©ë²•**: í…ŒìŠ¤íŠ¸ë§ˆë‹¤ ìƒˆ browser context ìƒì„±

#### H2: Port/Connection ì†Œì§„

- ë§ì€ HTTP ì—°ê²° í›„ TCP connection ë˜ëŠ” port ì†Œì§„
- **ê²€ì¦ ë°©ë²•**: `netstat` ë˜ëŠ” connection ìˆ˜ ëª¨ë‹ˆí„°ë§

#### H3: httpx Client ë¦¬ì†ŒìŠ¤ ëˆ„ìˆ˜

- clean_state fixtureì˜ httpx í˜¸ì¶œì´ connectionì„ ì œëŒ€ë¡œ í•´ì œ ì•ˆí•¨
- **ê²€ì¦ ë°©ë²•**: httpx.Client context manager ì‚¬ìš©

#### H4: í…ŒìŠ¤íŠ¸ ê°„ ìƒíƒœ ëˆ„ì 

- ì—¬ëŸ¬ test class ì‹¤í–‰ ì‹œ ë‚´ë¶€ ìƒíƒœ ëˆ„ì 
- **ê²€ì¦ ë°©ë²•**: test classë³„ë¡œ ë³„ë„ moduleë¡œ ë¶„ë¦¬

### 6.7 Final Solution âœ…

#### Root Cause: Playwright Browser Context ìƒíƒœ ì˜¤ì—¼

pytest-playwrightì˜ ê¸°ë³¸ ë™ì‘:
- **Browser**: session scope (ì „ì²´ í…ŒìŠ¤íŠ¸ ì„¸ì…˜ì—ì„œ 1ê°œ)
- **Context**: function scope (ê° í…ŒìŠ¤íŠ¸ë§ˆë‹¤ ìƒˆë¡œ ìƒì„±)
- **Page**: function scope (ê° í…ŒìŠ¤íŠ¸ë§ˆë‹¤ ìƒˆë¡œ ìƒì„±)

ë¬¸ì œ: ë™ì¼í•œ browserì—ì„œ ë§ì€ context/pageë¥¼ ìƒì„±í•˜ë©´ browser ìƒíƒœê°€ ì˜¤ì—¼ë¨

#### Fix: Class-Scoped Browser Context

**ë³€ê²½ ë‚´ìš©** (`test_playground.py`):

```python
@pytest.fixture(scope="class")
def class_context(browser):
    """í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ë§ˆë‹¤ ìƒˆë¡œìš´ browser context ìƒì„±"""
    context = browser.new_context()
    yield context
    context.close()


@pytest.fixture
def class_page(class_context: BrowserContext) -> Page:
    """class_contextì—ì„œ ìƒˆ í˜ì´ì§€ ìƒì„±"""
    page = class_context.new_page()
    yield page
    page.close()


@pytest.fixture
def playground_page(
    class_page: Page,  # ë³€ê²½: page â†’ class_page
    ...
):
    ...
```

#### ì¶”ê°€ Fix: httpx Connection ì •ë¦¬

```python
def _reset():
    # httpx Clientë¥¼ context managerë¡œ ì‚¬ìš©í•˜ì—¬ ì—°ê²° ì •ë¦¬ ë³´ì¥
    try:
        with httpx.Client(timeout=10.0) as client:
            response = client.post(f"{backend_url}/test/reset-data")
            ...
```

### 6.8 Results

#### Before (ìˆ˜ì • ì „)
```
5 failed, 3 passed, 1 skipped, 9 errors in 376.96s
```

#### After (ìˆ˜ì • í›„)
```
12 failed, 5 passed, 1 skipped in 397.81s
```

| ì§€í‘œ | ìˆ˜ì • ì „ | ìˆ˜ì • í›„ | ë³€í™” |
|------|---------|---------|------|
| PASSED | 3 | 5 | +2 |
| FAILED | 5 | 12 | +7 (ERROR â†’ FAILED) |
| ERROR | 9 | **0** | **-9 (ì„œë²„ ë¸”ë¡œí‚¹ í•´ê²°)** |
| SKIPPED | 1 | 1 | 0 |

**í•µì‹¬ ì„±ê³¼**:
- ERROR 9ê°œ â†’ 0ê°œ (ì„œë²„ ë¸”ë¡œí‚¹ ì™„ì „ í•´ê²°)
- ì´ì œ ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë¨ (íƒ€ì„ì•„ì›ƒ/ë¸”ë¡œí‚¹ ì—†ìŒ)
- ë‚¨ì€ FAILEDëŠ” UI ìš”ì†Œ ë¯¸êµ¬í˜„ ë¬¸ì œ (ë³„ë„ ì‘ì—… í•„ìš”)

### 6.9 Lessons Learned

1. **Browser State Isolation**: Playwright browserëŠ” session scopeë¡œ ê³µìœ ë˜ì§€ë§Œ, ë§ì€ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œ ìƒíƒœ ì˜¤ì—¼ ë°œìƒ
2. **Class-Scoped Context**: í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ë³„ë¡œ contextë¥¼ ë¶„ë¦¬í•˜ë©´ ê²©ë¦¬ ë³´ì¥
3. **Connection Management**: httpxëŠ” context managerë¡œ ì‚¬ìš©í•´ì•¼ connection ì •ë¦¬ ë³´ì¥
4. **Pre-check Importance**: ì„œë²„ health checkë¥¼ Playwright ì™¸ë¶€ì—ì„œ ë¨¼ì € ìˆ˜í–‰í•˜ë©´ ë¬¸ì œ ì›ì¸ íŒŒì•…ì— ë„ì›€

---

*Created: 2026-02-05*
*Updated: 2026-02-06 - Server Blocking Issue í•´ê²° ì™„ë£Œ*
*Context: Phase 5.1 êµ¬í˜„ í›„ E2E í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ë¶„ì„*
*Status: âœ… RESOLVED*
