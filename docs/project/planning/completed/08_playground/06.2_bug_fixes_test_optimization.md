# Plan: Test Environment Optimization & Bug Fixes

## Context

Plan 08 (Playground) Phase 6 bug fixes are complete. 9 test failures remain (4 JS + 5 Python), plus hardcoded values, inconsistent constants, and documentation gaps. This plan addresses all issues holistically for **global optimization**.

**Current state:** 842/851 tests passing (98.9%) → Target: 851/851 (100%)

---

## Regression Prevention Strategy

매 Phase 시작 전/후 테스트를 실행하여 의도치 않은 영향을 즉시 감지합니다.

| Checkpoint | When | Command | Expected |
|-----------|------|---------|----------|
| **Baseline** | 시작 전 | `pytest tests/unit tests/integration -q --tb=line` + `npm test` | 현재 상태 기록 (9 failures) |
| **After Phase 1** | Foundation 완료 후 | 동일 | Baseline과 **동일** (기능 변경 없음, 상수/경로만 변경) |
| **After Phase 2** | JS 수정 후 | `cd tests/manual/playground && npm test` | JS 4 failures → **0** |
| **After Phase 3** | Python 수정 후 | `pytest tests/integration -q --tb=line` | Python 5 failures → **0** |
| **Final** | 전체 완료 | 전체 unit+integration+coverage | **851/851 Green** |

**핵심:** Phase 1은 기능 변경 없이 상수/환경변수만 변경하므로 baseline과 동일해야 합니다. 결과가 다르면 즉시 rollback 후 원인 분석.

---

## Phase 1: Foundation -- Constants & Environment Variables

> Remove hardcoding, establish single source of truth. All subsequent fixes build on this.
> **검증:** 완료 후 baseline과 동일한 테스트 결과 확인

### Step 1.1: Test Token Consolidation (DRY)

**Problem:** Two different tokens in two files.

| File | Current | Issue |
|------|---------|-------|
| [tests/integration/conftest.py:9](tests/integration/conftest.py#L9) | `"test-extension-token-1234567890abcdefghijkl"` (43 chars) | Used by `http_client` fixture |
| [tests/integration/adapters/conftest.py:32](tests/integration/adapters/conftest.py#L32) | `"test-extension-token"` (20 chars) | Used by `authenticated_client` fixture |

**Impact analysis (safe):**
- `http_client` fixture: `token_provider.reset(TEST_EXTENSION_TOKEN)` → 서버 토큰 설정
- [test_page_context_api.py](tests/integration/adapters/test_page_context_api.py#L6): `from tests.integration.conftest import TEST_EXTENSION_TOKEN` → 같은 변수 사용
- [test_tool_call_api.py](tests/integration/adapters/test_tool_call_api.py#L11): 동일 패턴
- **결론:** 값 변경해도 fixture와 test가 같은 import를 사용하므로 자동 동기화됨 ✅

**Fix:** `tests/integration/conftest.py:9` → `TEST_EXTENSION_TOKEN = "test-extension-token"`

### Step 1.2: MCP URL Parameterization

**Problem:** Hardcoded ports `9000/9001/9002` in multiple files.

| File | Line | Current |
|------|------|---------|
| [tests/integration/conftest.py:18](tests/integration/conftest.py#L18) | `return "http://127.0.0.1:9000/mcp"` | No env var |
| [tests/integration/adapters/conftest.py:33](tests/integration/adapters/conftest.py#L33) | `MCP_TEST_URL = "http://127.0.0.1:9000/mcp"` | No env var |
| [tests/integration/adapters/conftest.py:37-39](tests/integration/adapters/conftest.py#L37-L39) | `MCP_AUTH_TEST_URLS` dict | Hardcoded 9000/9001/9002 |

**Fix:** Derive from `MCP_TEST_PORT` env var (pattern already proven in root [conftest.py:129](tests/conftest.py#L129)):
```python
_mcp_port = int(os.environ.get("MCP_TEST_PORT", "9000"))
MCP_TEST_URL = f"http://127.0.0.1:{_mcp_port}/mcp"
MCP_AUTH_TEST_URLS = {
    "no_auth": f"http://127.0.0.1:{_mcp_port}/mcp",
    "api_key": f"http://127.0.0.1:{_mcp_port + 1}/mcp",
    "oauth": f"http://127.0.0.1:{_mcp_port + 2}/mcp",
}
```

Also update `mcp_test_server_url` fixture in `tests/integration/conftest.py:13-18`:
```python
@pytest.fixture(scope="session")
def mcp_test_server_url():
    port = int(os.environ.get("MCP_TEST_PORT", "9000"))
    return f"http://127.0.0.1:{port}/mcp"
```

### Step 1.3: E2E Port Parameterization

**Problem:** Hardcoded `8000` and `3000` in E2E tests.

**Files & hardcoded locations:**

| File | Lines | Port | Usage |
|------|-------|------|-------|
| [tests/e2e/conftest.py:35](tests/e2e/conftest.py#L35) | `"http://localhost:8000"` | 8000 | `server_url` fixture |
| [tests/e2e/conftest.py:60](tests/e2e/conftest.py#L60) | `"--port", "8000"` | 8000 | subprocess 실행 |
| [tests/e2e/conftest.py:68](tests/e2e/conftest.py#L68) | `"http://localhost:8000/health"` | 8000 | health check |
| [tests/e2e/test_playground.py:68](tests/e2e/test_playground.py#L68) | `"http://localhost:3000"` | 3000 | `playground_url` |
| [tests/e2e/test_playground.py:74](tests/e2e/test_playground.py#L74) | `"http://localhost:8000"` | 8000 | `backend_url` |
| [tests/e2e/test_playground.py:84](tests/e2e/test_playground.py#L84) | `"--port", "8000"` | 8000 | subprocess |
| [tests/e2e/test_playground.py:113](tests/e2e/test_playground.py#L113) | `"3000"` | 3000 | static server |
| [tests/e2e/test_playground.py:120](tests/e2e/test_playground.py#L120) | `("localhost", 3000)` | 3000 | health check |

**Fix:** Add env vars `E2E_SERVER_PORT` (default `8000`), `E2E_STATIC_PORT` (default `3000`).

**Consistency 보장:** fixture, subprocess `--port`, health check URL 모두 같은 변수에서 derive:
```python
# test_playground.py
_backend_port = int(os.environ.get("E2E_SERVER_PORT", "8000"))
_static_port = int(os.environ.get("E2E_STATIC_PORT", "3000"))

@pytest.fixture(scope="module")
def playground_url():
    return f"http://localhost:{_static_port}"

@pytest.fixture(scope="module")
def backend_url():
    return f"http://localhost:{_backend_port}"

# backend_server fixture: "--port", str(_backend_port)
# static_server fixture: "-m", "http.server", str(_static_port)
```

### Step 1.4: Hardcoded Windows Paths (3 locations)

**Problem:** Machine-specific paths hardcoded.

| File | Line | Content |
|------|------|---------|
| [tests/conftest.py:396](tests/conftest.py#L396) | Code | `Path(r"C:\Users\sungb\...")` |
| [tests/integration/adapters/conftest.py:65](tests/integration/adapters/conftest.py#L65) | Docstring | `cd C:\\Users\\sungb\\...` |
| [tests/docs/RESOURCES.md:14](tests/docs/RESOURCES.md#L14) | Docs | `C:\Users\sungb\...` |

**Fix (code):**
```python
synapse_dir = Path(os.environ.get(
    "SYNAPSE_DIR",
    str(Path.home() / "Documents" / "GitHub" / "MCP_SERVER" / "MCP_Streamable_HTTP")
))
```

**Fix (docstring):** Update to `SYNAPSE_DIR env var or ~/Documents/GitHub/MCP_SERVER/...`

**Fix (docs):** Phase 4에서 처리

---

## Phase 2: JavaScript Test Fixes (4 tests → 0 failures)

> **검증:** `cd tests/manual/playground && npm test` → 32/32 Green

### Step 2.1: Fix `getUsage` URL (Fix TEST)

**File:** [tests/manual/playground/tests/api-client.test.js:329](tests/manual/playground/tests/api-client.test.js#L329)

| | Path | Source |
|--|------|--------|
| Test expects | `/api/usage` | Wrong |
| Implementation | `/api/usage/summary` | Correct ([api-client.js:137](tests/manual/playground/js/api-client.js#L137)) |
| Backend route | `GET /summary` under prefix `/api/usage` | Ground truth |

**Fix:** `${API_BASE}/api/usage` → `${API_BASE}/api/usage/summary`

### Step 2.2: Fix `setBudget` Method & Body (Fix TEST)

**File:** [tests/manual/playground/tests/api-client.test.js:367-375](tests/manual/playground/tests/api-client.test.js#L367-L375)

| | Method | Body | Source |
|--|--------|------|--------|
| Test expects | `POST` | `{ limit: 20.0 }` | Wrong |
| Implementation | `PUT` | `{ monthly_budget_usd: limit }` | Correct ([api-client.js:145](tests/manual/playground/js/api-client.js#L145)) |
| Backend route | `PUT /budget` | `UpdateBudgetRequest(monthly_budget_usd)` | Ground truth |

**Fix:** `method: "POST"` → `"PUT"`, `{ limit: 20.0 }` → `{ monthly_budget_usd: 20.0 }`

### Step 2.3: Fix `renderServerCard` testid (Fix TEST)

**File:** [tests/manual/playground/tests/ui-components.test.js:74](tests/manual/playground/tests/ui-components.test.js#L74)

**Decision rationale (Fix TEST, not implementation):**
- Implementation: `createCard("mcp-server", server.name)` → testid = `mcp-server-{name}`
- E2E tests: `[data-testid='mcp-server-test-server']` (name-based) — **8 selectors**
- main.js handlers: `mcp-tools-btn-${server.name}`, `mcp-unregister-btn-${server.name}` — **3 selectors**
- Implementation을 `id`로 변경하면 **11곳이 깨짐**. Unit test 1곳 수정이 최소 영향.

**Fix:** `toBe("mcp-server-server-1")` → `toBe("mcp-server-Test Server")`

### Step 2.4: Fix `renderAgentCard` testid (Fix TEST)

Same reasoning: E2E uses `a2a-agent-echo-agent` (name-based).

**Fix:** `toBe("a2a-agent-agent-1")` → `toBe("a2a-agent-Test Agent")`

---

## Phase 3: Python Integration Test Fixes (5 tests → 0 failures)

> Root cause: `DEV_MODE=false` in `.env` → `/test/*` routes not registered → 404
> **검증:** `pytest tests/integration -q --tb=line` → 0 failures

### Step 3.1: Fix `test_dev_mode_test_utils.py` (3 tests)

**File:** [tests/integration/adapters/test_dev_mode_test_utils.py:17-28](tests/integration/adapters/test_dev_mode_test_utils.py#L17-L28)

**Current (broken):**
```python
monkeypatch.setenv("DEV_MODE", "true")
importlib.reload(src.config.settings)  # Doesn't reset Container singleton
from src.main import app  # Uses cached module-level app
```

**Why it fails:** `create_app()` in `src.main` runs at import time. `importlib.reload(settings)` 만으로는 Container singleton이 리셋되지 않아 `settings.dev_mode` 가 여전히 `False` → `/test/*` routes 미등록.

**Fix:** Adopt proven `create_app()` pattern ([authenticated_client](tests/integration/adapters/conftest.py#L99-L165)):
```python
@pytest.fixture
def client_dev_mode(self, monkeypatch, tmp_path):
    """DEV_MODE=true 환경의 테스트 클라이언트"""
    monkeypatch.setenv("DEV_MODE", "true")
    from src.adapters.inbound.http.app import create_app
    app = create_app()  # Fresh Container with DEV_MODE=true
    container = app.container
    container.reset_singletons()
    container.settings().storage.data_dir = str(tmp_path)
    with TestClient(app) as client:
        yield client
    container.reset_singletons()
    container.unwire()
```

**Container lifecycle safety:** `create_app()` calls `container.wire()` ([app.py:139](src/adapters/inbound/http/app.py#L139)), cleanup calls `container.unwire()`. 각 fixture가 독립적인 Container를 생성/정리하므로 간섭 없음 ✅

### Step 3.2: Fix `test_test_utils.py` (2 tests)

**File:** [tests/integration/adapters/test_test_utils.py:9,13-17](tests/integration/adapters/test_test_utils.py#L9)

**Current (broken):** Module-level `from src.main import app` → import 시점에 `DEV_MODE=false`로 app 생성됨.

**Fix:** Remove module-level import, create app inside fixture with DEV_MODE=true:
```python
@pytest.fixture
async def client_with_server(monkeypatch, tmp_path):
    """AsyncClient with DEV_MODE=true backend"""
    monkeypatch.setenv("DEV_MODE", "true")
    from src.adapters.inbound.http.app import create_app
    app = create_app()
    container = app.container
    container.reset_singletons()
    container.settings().storage.data_dir = str(tmp_path)
    async with AsyncClient(
        transport=ASGITransport(app=app), base_url="http://test"
    ) as client:
        yield client
    container.reset_singletons()
    container.unwire()
```

**Note:** 이 테스트는 `sample_mcp_url` fixture도 사용하며 실제 MCP 서버 필요. `mock_mcp_toolset_in_ci` (autouse)가 CI에서는 mock 처리. DEV_MODE 수정만으로 `/test/reset-data` 404 문제는 해결됨.

---

## Phase 4: Documentation & Guidelines

> **검증:** 문서 변경이므로 테스트 영향 없음. Final 검증에서 확인.

### Step 4.1: Update [tests/docs/CONFIGURATION.md](tests/docs/CONFIGURATION.md)

- Port table: add `E2E_SERVER_PORT`, `E2E_STATIC_PORT`
- Add row: `SYNAPSE_DIR` env var
- Add "Playground JS Tests" section: `cd tests/manual/playground && npm test`

### Step 4.2: Update [tests/docs/RESOURCES.md](tests/docs/RESOURCES.md)

- Line 14: Replace `C:\Users\sungb\...` → `Configurable via SYNAPSE_DIR env var. Default: ~/Documents/GitHub/MCP_SERVER/MCP_Streamable_HTTP`

### Step 4.3: Update [tests/README.md](tests/README.md)

- Verify/update coverage number (현재 표기: 89.90%)
- Add Playground (JS) test info to Quick Reference table

### Step 4.4: Add Guidelines to [CLAUDE.md](CLAUDE.md)

**Critical Don'ts** table에 추가:
```
| Hardcode paths/ports in test code | Use env vars with defaults: `os.environ.get("KEY", "default")` |
```

**Key Principles**에 추가 (짧게):
```
6. **Test Environment Isolation**
   - Tests MUST NOT depend on `.env` for test-specific config (use `monkeypatch.setenv()`)
   - App creation in fixtures: use `create_app()`, never `from src.main import app`
   - Machine-specific paths: use env vars with `Path.home()` fallback
```

---

## Side-Effect Analysis

| 변경 | 잠재적 영향 | 방지 대책 |
|------|-----------|----------|
| Token 값 변경 (1.1) | `test_page_context_api`, `test_tool_call_api`에서 `TEST_EXTENSION_TOKEN` import 사용 | 같은 import source이므로 자동 동기화 ✅ |
| MCP URL env var (1.2) | 기본값 `9000`이 현재 동작과 동일 | 환경변수 미설정 시 기존과 동일 ✅ |
| E2E port env var (1.3) | subprocess `--port`와 fixture URL 불일치 가능 | 같은 변수에서 derive하여 일관성 보장 ✅ |
| Container unwire (3.1/3.2) | 다른 테스트의 DI wiring에 간섭 | 각 fixture가 독립 Container 생성/정리 ✅ |
| testid 변경 (2.3/2.4) | E2E tests에 영향? | Test만 변경, implementation 미변경 → E2E 무관 ✅ |

---

## Files Changed Summary

| Phase | File | Change |
|-------|------|--------|
| 1.1 | `tests/integration/conftest.py` | Token → `"test-extension-token"` |
| 1.2 | `tests/integration/conftest.py` | `mcp_test_server_url` → env var |
| 1.2 | `tests/integration/adapters/conftest.py` | MCP URLs → env var derived |
| 1.3 | `tests/e2e/conftest.py` | Port → `E2E_SERVER_PORT` env var |
| 1.3 | `tests/e2e/test_playground.py` | Port → env var derived fixtures |
| 1.4 | `tests/conftest.py` | Windows path → `SYNAPSE_DIR` + `Path.home()` |
| 1.4 | `tests/integration/adapters/conftest.py` | Docstring path 업데이트 |
| 2.1 | `tests/manual/playground/tests/api-client.test.js` | getUsage URL assertion |
| 2.2 | `tests/manual/playground/tests/api-client.test.js` | setBudget method+body |
| 2.3 | `tests/manual/playground/tests/ui-components.test.js` | renderServerCard testid |
| 2.4 | `tests/manual/playground/tests/ui-components.test.js` | renderAgentCard testid |
| 3.1 | `tests/integration/adapters/test_dev_mode_test_utils.py` | Fixture rewrite |
| 3.2 | `tests/integration/adapters/test_test_utils.py` | Fixture rewrite |
| 4.1 | `tests/docs/CONFIGURATION.md` | Env vars, Playground section |
| 4.2 | `tests/docs/RESOURCES.md` | Remove hardcoded path |
| 4.3 | `tests/README.md` | Coverage, Playground info |
| 4.4 | `CLAUDE.md` | Test isolation guidelines |
